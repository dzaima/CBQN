# list all .c & .h files
enableSingeli â† 0
additionalFlags â† âŸ¨âŸ©

allFiles â† âŸ¨âŸ©
{'d'=â€¢file.Typeğ•©? ğ•ŠÂ¨ ğ•©âŠ¸â€¢file.AtÂ¨ â€¢file.Listğ•©; allFilesâˆ¾â†© <ğ•©} ""
allFiles {âŠ‘(<Â¯2â†‘ğ•©)âˆŠ".c"â€¿".h"}Â¨âŠ¸/â†©

initialFlags â† âŸ¨
  "/usr/bin/clang","-std=gnu11","-Wall","-DCLANGD","-DFFI=2","-DCBQN_EXPORT","-fms-extensions"
  "-Wno-microsoft-anon-tag","-Wno-unused-function","-Wno-undefined-internal","-Wno-bitwise-instead-of-logical","-Wno-unknown-warning-option"
âŸ© âˆ¾ additionalFlags âˆ¾ enableSingeli/âŸ¨"-DSINGELI","-march=native"âŸ©

Escâ†{
  in â† (@+0â€¿9â€¿10â€¿13)âˆ¾"'"""   # Null, Tab, LF, CR, and quotes
  out â† "0tnr"               # Whitespace characters changed to letters
  i â† inâŠğ•©
  ğ•© â†© i âŠâŸœoutâŒ¾((i<â‰ out)âŠ¸/) ğ•© # Replace
  âˆ¾(i<â‰ in) /âŸœ"\"âŠ¸âˆ¾Â¨ ğ•©        # Insert \
}
nâ†@+10
JStr â† {âˆ¾âŸ¨"""",Esc ğ•©,""""âŸ©}
JArr â† {'['âˆ¾']'âˆ¾Ëœ2â†“âˆ¾ğ•¨âŠ¸âˆ¾Â¨ ğ•©}
JObj â† {âˆ¾âŸ¨'{',n,Â¯2â†“âˆ¾(JStrÂ¨ğ•¨) {âˆ¾âŸ¨"  ",ğ•¨,": ",ğ•©,',',nâŸ©}Â¨ ğ•©, n,'}'âŸ©}

flagKâ†âŸ¨âŸ©
flagVâ†âŸ¨âŸ©
WantsFlags â† {
  ğ•¨ â€¢file.Atâ†©
  # â€¢Out ğ•¨âˆ¾" wants flags "âˆ¾JArr JStrÂ¨ ğ•©
  flagKâˆ¾â†© <ğ•¨
  flagVâˆ¾â†© <ğ•©
}
WantsIncludes â† {
  ğ•¨ WantsFlags âˆ¾ ("-include"â‹ˆâ€¢file.At)Â¨ ğ•©
}

FilterPrefix â† {ğ•¨âŠ¸{ğ•¨â‰¡(â‰ ğ•¨)â†‘ğ•©}Â¨âŠ¸/ ğ•©}

# main core.h sequence, assuming MM==1
coreIncludes â† âŸ¨"h.h","core/stuff.h","core/heap.h","opt/mm_buddy.h","core/gstack.h","core/harr.h","core/numarr.h","core/chrarr.h","core/fillarr.h","core/derv.h","core/arrFns.h"âŸ©
{(Â¯1âŠ‘ğ•©) WantsIncludes Â¯1â†“ğ•©}Â¨ 2â†“â†‘ coreIncludes
CoreTil â† {coreIncludesâ†‘ËœâŠ‘coreIncludesâŠ<ğ•©}

# MM==0 and MM==2
coreTilMM â† CoreTil "opt/mm_buddy.h"
{ğ•© WantsIncludes coreTilMM}Â¨ "opt/mm_2buddy.h"â€¿"opt/mm_malloc.h"

# non-'utils/' headers & optional .c files
{ğ•© WantsIncludes âŸ¨"core.h"âŸ©}Â¨ âŸ¨
  "ns.h", "vm.h", "builtins.h"
  "opt/mm_malloc.c", "opt/mm_buddy.c", "opt/mm_2buddy.c", "opt/mm_buddyTemplate.c", "opt/mm_buddyTemplate.h", "opt/gc.c", "opt/gc.h"
  "builtins/radix.h"
  "jit/nvm.h"
âŸ©
# and all the utils/ onces
{ğ•© WantsIncludes âŸ¨"core.h"âŸ©}Â¨ "utils/" FilterPrefix allFiles
# and some other things
"core/tyarrTemplate.h" WantsIncludes CoreTil "core/chrarr.h"
"core/tyarrTemplate.c" WantsIncludes âŸ¨"core/tyarr.c"âŸ©
"builtins/grade.h" WantsIncludes âŸ¨"builtins/sort.c"âŸ©
"singeli/c/arithdDispatch.c" WantsIncludes âŸ¨"builtins/arithd.c"âŸ©
"singeli/c/cmp.c" WantsIncludes âŸ¨"builtins/cmp.c"âŸ©
"utils/hashmapTemplate.h" WantsIncludes âŸ¨"utils/hash.h"âŸ©


# give the expected environment for configuration-specific files
"opt/mm_2buddy.c" WantsFlags âŸ¨"-DMM=2"âŸ©
"opt/mm_malloc.c" WantsFlags âŸ¨"-DMM=0"âŸ©
"utils/valgrind.h" WantsFlags âŸ¨"-DUSE_VALGRIND"âŸ©
"core/heap.h" WantsFlags âŸ¨"-DHEAP_VERIFY"âŸ©
{ğ•© WantsFlags âŸ¨"-DSINGELI"âŸ©}Â¨ "singeli/c/" FilterPrefix allFiles

# template files
"builtins/sortTemplate.h" WantsIncludes âŸ¨"core.h", "utils/talloc.h"âŸ©
"builtins/sortTemplate.h" WantsFlags âŸ¨"-DSORT_NAME=", "-DSORT_TYPE=B", "-DSORT_CMP=compare"âŸ©

# deduplicate flag files
gfk â† â·flagK
gfv â† âˆ¾Â¨ (âŠflagK) âŠ” flagV

# resolve flags to actual files
allFlags â† (gfkâŠâ€¢file.AtÂ¨ allFiles)âŠgfv âˆ¾ <âŸ¨âŸ©

FileObj â† {
  "file"â€¿"directory"â€¿"arguments" JObj âŸ¨JStr ğ•¨, JStr â€¢path, ", " JArr JStrÂ¨ initialFlagsâˆ¾ğ•©âŸ©
}

resPath â† â‰ â—¶âŸ¨"../compile_commands.json", â€¢wdpathâ€¢file.AtâŠ‘âŸ© â€¢args
resPath â€¢FChars (","âˆ¾n) JArr allFiles FileObjÂ¨ allFlags
â€¢Out "Wrote clangd compile commands to "âˆ¾â€¢file.At resPath