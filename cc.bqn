#! /usr/bin/env dbqn
# Modified version of https://github.com/mlochbaum/BQN/blob/master/src/cjs.bqn, which is under the ISC license (https://github.com/mlochbaum/BQN/blob/master/LICENSE)

argsâ†â€¢args
"Usage: ./cc.bqn path/to/mlochbaum/BQN <one of [rcfe] or an expression>"!2â‰¤â‰ args
return â† 1â‰¡âŠ‘args
argsâ†“Ëœâ†© return
pathâ†(âŠ‘args)âˆ¾"/src/"
argsâ†“Ëœâ†©1
L  â† {"m_caB("  âˆ¾(â•â‰ ğ•©)âˆ¾",(B[]){"  âˆ¾(1â†“âˆ¾","âŠ¸âˆ¾Â¨ğ•©)âˆ¾"})"}
LI â† {"m_cai32("âˆ¾(â•â‰ ğ•©)âˆ¾",(i32[]){"âˆ¾(1â†“âˆ¾","âŠ¸âˆ¾Â¨ğ•©)âˆ¾"})"}
# Escape the special characters that appear in BQN sources.
Escâ†{
  in â† (@+0â€¿9â€¿10â€¿13)âˆ¾"'"""   # Null, Tab, LF, CR, and quotes
  out â† "0tnr"               # Whitespace characters changed to letters
  i â† inâŠğ•©
  ğ•© â†© i âŠâŸœoutâŒ¾((i<â‰ out)âŠ¸/) ğ•© # Replace
  âˆ¾(i<â‰ in) /âŸœ"\"âŠ¸âˆ¾Â¨ ğ•©        # Insert \
}
Str â† "m_str32(U"""âˆ¾Escâˆ¾""")"Ë™    # A BQN string
Char â† {"m_c32(U'"âˆ¾(Escâ¥Šğ•©)âˆ¾"')"} # A BQN character
Num â† {sâ†"-"/Ëœğ•©<0 â‹„ âˆâŠ¸=âˆ˜|â—¶âŸ¨"m_f64("âˆ¾")"âˆ¾Ëœsâˆ¾â•âˆ˜| â‹„ "m_f64("âˆ¾sâˆ¾"1.0/0.0)"âŸ©ğ•©} # Format number

F â† â•  # Format number

Import â† {ğ•¨â€¢Import pathâˆ¾ğ•©}
FChars â† {ğ•¨â€¢FChars pathâˆ¾ğ•©}
FLines â† {ğ•¨â€¢FLines pathâˆ¾ğ•©}

glyphs â† Import "glyphs.bqn"
_getComp â† { (3+useInd) â†‘ (ğ•— Import "c.bqn"){ğ”½} }
useInd â† "-i"â‰¡âŠ‘args â‹„ argsâ†“Ëœâ†©useInd
Comp â† ((<"inc(runtime["âˆ¾â•âˆ¾"])"Ë™)Â¨â†•62) glyphs _getComp âŠ¢
J â† âˆ¾âˆ¾âŸœ\nÂ¨
Fconst â† â‰¡â—¶âŸ¨@âŠ¸â‰¤â—¶Numâ€¿Char, Str, âŠ‘âŸ©
Fout â† {((â‰ ğ•©)â†‘âŸ¨LI FÂ¨,L FconstÂ¨,L (LI Â·FÂ¨ 4â†‘âŠ¢)Â¨,L (L FÂ¨)Â¨âŸ©) {ğ•ğ•©}Â¨ ğ•©}
Frun â† 1âŠ¸Fout
Long â† {Â¯2â†“âˆ¾ğ•©âˆ¾Â¨<","âˆ¾\n}

RT â† {
  srcâ€¿needâ€¿inputsâ†ğ•©Import"pr.bqn"
  prâ†"runtime_0"â€¿"provide"{(âˆ¾ğ•¨<âŠ¸(<âˆ˜{âˆ¾"inc("â€¿ğ•¨â€¿"["â€¿ğ•©â€¿"])"}âŸœFÂ¨)âŸœ(â†•â‰ )Â¨ğ•©)âŠËœ(âˆ¾ğ•©)âŠâˆ¾need}â—‹((-1+1=ğ•©)âŠ¸â†‘)inputs
  Long Fout pr need _getComp src
}
CArg â† {J (Â¯5âŠ¸â†“âˆ¾ğ•©Ë™)âŒ¾âŠ‘ FLines "c.bqn"}
LFC â† Longâˆ˜Foutâˆ˜Comp

â€¢OutâŸ(Â¬return) (âŠ‘"r"â€¿"r0"â€¿"r1"â€¿"c"â€¿"cc"â€¿"f"â€¿"e"â€¿"p"âŠâŠ)â—¶âŸ¨
  RTâˆ˜2, RTâˆ˜0, RTâˆ˜1
  {ğ•©â‹„LFC CArg "âŸ¨"âˆ¾"âŸ©"Â«âˆ¾","âŠ¸âˆ¾Â¨'"'(âŠ£âˆ¾âˆ¾Ëœ)Â¨glyphs}
  {ğ•©â‹„LFC "{"âˆ¾"}"âˆ¾ËœCArg"ğ•©"}
  {ğ•©â‹„LFC FChars "f.bqn"}
  {ğ•©â‹„LFC SVG "e"}
  {ğ•©â‹„LFC SVG "p"}
  Â¯1 â†“ Â· J Lâˆ˜Foutâˆ˜CompÂ¨
âŸ© args