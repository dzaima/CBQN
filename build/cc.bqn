#!/usr/bin/env bqn
# Modified version of https://github.com/mlochbaum/BQN/blob/master/src/cjs.bqn

args â† â€¢args
"Usage: ./cc.bqn path/to/mlochbaum/BQN [-i] [-n name] <(r|r0|r1|r1x|c|cc|f|e|p) or an expression>"!2â‰¤â‰ args
NextArg â† {ğ•Š: (argsâ†“Ëœâ†©1) âŠ¢ âŠ‘args}
TryArg â† {ğ•©â‰¡âŠ‘args? 1 âŠ£ NextArg@; 0}

return â† TryArg 1
bqnpath â† (NextArg@) â€¢file.At "src"
srcmap â† TryArg "-i"
name â† TryArgâ—¶"(precompiled)"â€¿NextArg "-n"

Import â† {ğ•¨ â€¢Import bqnpath â€¢file.At ğ•©}
FChars â† {ğ•¨ â€¢FChars bqnpath â€¢file.At ğ•©}
FLines â† {ğ•¨ â€¢FLines bqnpath â€¢file.At ğ•©}

F â† â€¢Repr # Format number
Join â† {(-â‰ ğ•¨)â†“ âˆ¾âˆ¾âŸœğ•¨Â¨ ğ•©}

FmtComp â† {
  # Escape the special characters that appear in BQN sources.
  Esc â† {
    in â† (@+0â€¿9â€¿10â€¿13)âˆ¾"'"""   # Null, Tab, LF, CR, and quotes
    out â† "0tnr"               # Whitespace characters changed to letters
    i â† inâŠğ•©
    ğ•© â†© i âŠâŸœoutâŒ¾((i<â‰ out)âŠ¸/) ğ•© # Replace
    âˆ¾(i<â‰ in) /âŸœ"\"âŠ¸âˆ¾Â¨ ğ•©        # Insert \
  }
  
  U32Len â† (â‰  - Â·+Â´ â‰¥âŸœ55296 âˆ§ â‰¤âŸœ56319)-âŸœ@ # for dzaima/BQN; shouldn't break things in proper BQN impls, as surrogate values don't map to valid codepoints
  
  CStr â† {"""" (âˆ¾âˆ¾âŠ£) Esc ğ•©}
  
  List â† (0<â‰ )â—¶âŸ¨"",1â†“Â·âˆ¾","âŠ¸âˆ¾Â¨âŸ©
  
  lf â† â¥Š@+10
  Cache â† {
    tag â† ğ•©
    values â† âŸ¨âŸ©
    Add â‡ {(valuesâˆ¾â†© <ğ•©) âŠ¢ tagâ‹ˆâ‰ values}
    Done â‡ { ğ•Š:
      unq â† âŠvalues
      uncomp â‡ {(â‹â‰ Â¨ ğ•©/values) âŠ /ğ•©} âˆŠunq # compressed index â†’ canonical original index; sort by length to make length predictable
      comp â‡ (uncompâŠunq)âŠunq             # original index â†’ compressed index
      counts â‡ /â¼comp                     # compressed index â†’ count of such
      compvals â‡ uncompâŠvalues            # compressed index â†’ data
      n â‡ â‰ uncomp
    }
  }
  
  intarrCache â† Cache 1
  Li â† intarrCache.Add
  _Lo â† {{âˆ¾âŸ¨"m_lvB_", Fâ‰ ğ•©, "(", List ğ•©, ")"âŸ©} ğ”½Â¨ğ•©}
  OStr2C â† { # A BQN string
    aâ†âˆ§Â´ğ•©<128+@
    âˆ¾âŸ¨aâŠ‘"m_c32vec"â€¿"m_c8vec","(",aÂ¬âŠ¸â¥Š"U","",CStrğ•©,",",â€¢Repr U32Len ğ•©,")"âŸ©
  }
  OChr2C â† {"m_c32(U'"âˆ¾(Escâ¥Šğ•©)âˆ¾"')"} # A BQN character
  ONum2C â† {sâ†"-"/Ëœğ•©<0 â‹„ âˆâŠ¸=âˆ˜|â—¶âŸ¨"m_f64("âˆ¾")"âˆ¾Ëœsâˆ¾Fâˆ˜| â‹„ "m_f64("âˆ¾sâˆ¾"1.0/0.0)"âŸ©ğ•©} # Format number
  OAny2C â† â‰¡â—¶âŸ¨@âŠ¸â‰¤â—¶ONum2Câ€¿OChr2C, OStr2C, âŠ‘âŸ©
  
  TmpNum â† 0âŠ¸â‹ˆ
  # 0â€¿123: number
  # 1â€¿n: int arr ref
  # âŸ¨a,b,câŸ©: obj arr
  # "foo": literal code
  a â† ((â‰ ğ•©)â†‘âŸ¨Li â‹„ OAny2CÂ¨ â‹„ {0=âŒˆÂ´=Â¨ğ•©? Li ğ•©; =â—¶âŸ¨TmpNum,LiÂ¨âŸ©Â¨ ğ•©}Â¨ â‹„ (Li 2âŠ¸â†‘)Â¨ â‹„ LiÂ¨ â‹„ OStr2CâŸ©) {ğ•ğ•©}Â¨ ğ•©
  
  iarrs â† intarrCache.Done@ â‹„ Liâ†©!
  
  hasEmpty â† âŸ¨âŸ© â‰¡ âŠ‘iarrs.compvals
  
  init â† âŸ¨âŸ©
  a {
    1â€¿i: n â† iâŠ‘iarrs.comp â‹„ (hasEmptyâˆ§0=n) âŠ‘ âŸ¨âˆ¾âŸ¨"iarrs[",F n,"]"âŸ©, "iarrs0"âŸ©; # special-case first array (i.e. empty array) as there isn't enough aliasing info for the compiler to deduplicate loads
    2=â€¢TypeâŠ‘ğ•©? ğ•©;
    0â€¿n: ONum2C n;
    âŸ¨0â€¿a, 0â€¿b, âŸ¨c, dâŸ©âŸ©: csâ‰¡âŒŠcsâ†aâ€¿b? âˆ§Â´csâ‰¥0? âˆ§Â´cs<4? âˆ¾âŸ¨"m_blockinfo(", F a+bÃ—4, ", ", ğ•Š c, ", ", ğ•Š d, ")"âŸ©;
    4â‰¥â‰ ğ•©? ğ•Š_Lo ğ•©;
    n â† "a" âˆ¾ F â‰ init
    np â† nâˆ¾"p"
    initâˆ¾â†©< âˆ¾âŸ¨lf
      "B ", n, "; B* ", np, " = m_lvBn(&", n, ", ", F â‰ ğ•©, ");", lf
      "assume_separate_storage(", np, ", ", "iarrs", ");", lf # allow the compiler to vectorize copying from iarrs to np if so beneficial
    âŸ© âˆ¾ (â‹{âŠ‘'('âˆŠğ•©}Â¨)âŠ¸âŠ {âˆ¾âŸ¨np,"[", F ğ•©, "] = ", ğ•¨, ";", lfâŸ©}Â¨âŸœâ†•âŸœâ‰  ğ•ŠÂ¨ ğ•©
    n
  }Â¨â†©
  
  âˆ¾âŸ¨
    "B iarrs[", F iarrs.n, "];", lf
    "static const i32 iarrs_data[] = {", lf
      âˆ¾ âˆ¾âŸœlfÂ¨ {âˆ¾âŸ¨âˆ¾âˆ¾âŸœ','Â¨ FÂ¨ ğ•¨, " // ", F ğ•©âŸ©}Â¨âŸœâ†•âŸœâ‰  iarrs.compvals
    "};", lf
    "static const u32 iarrs_lens[] = {", ','Join Fâˆ˜â‰ Â¨ iarrs.compvals, "};", lf
    "init_intarrs(iarrs, iarrs_data, iarrs_lens, ", F iarrs.n, ");", lf
    hasEmpty / "B iarrs0 = iarrs[0];", lf
    âˆ¾{0ğ•Šğ•©: ""; âˆ¾âŸ¨"incByG(iarrs[", F ğ•©, "], ", F ğ•¨, ");", lfâŸ©}Â¨âŸœâ†•âŸœâ‰  iarrs.counts-1
    âˆ¾init
    "load_importBlock", srcmap/"_src", "(", CStr name, ",", lf
      (','âˆ¾lf) Join "  "âŠ¸âˆ¾Â¨ a
      lf
    ");"
  âŸ©
}

primN â† âŸ¨
  "add",      "sub",     "mul",    "div",   "pow",     "root",      "floor",  "ceil",  "stile",   "not"
  "and",      "or",      "lt",     "gt",    "ne",      "eq",        "le",     "ge",    "feq",     "fne"
  "ltack",    "rtack",   "shape",  "join",  "couple",  "pair",      "take",   "drop",  "ud",      "shifta"
  "shiftb",   "reverse", "transp", "slash", "gradeUp", "gradeDown", "select", "pick",  "indexOf", "count"
  "memberOf", "find",    "group",  "asrt",  "const",   "swap",      "cell",   "each",  "tbl",     "undo"
  "fold",     "insert",  "scan",   "atop",  "over",    "before",    "after",  "under", "val",     "cond"
  "rank",     "depth",   "repeat", "catch"
âŸ©
primC â† "+-Ã—Ã·â‹†âˆšâŒŠâŒˆ|Â¬âˆ§âˆ¨<>â‰ =â‰¤â‰¥â‰¡â‰¢âŠ£âŠ¢â¥Šâˆ¾â‰â‹ˆâ†‘â†“â†•Â«Â»âŒ½â‰/â‹â’âŠâŠ‘âŠâŠ’âˆŠâ·âŠ”!Ë™ËœË˜Â¨âŒœâ¼Â´Ë`âˆ˜â—‹âŠ¸âŸœâŒ¾âŠ˜â—¶â‰âš‡âŸâŠ"
pre â† "+-=Ã—â†•â‰¢â‰¤âŠ‘âŠ˜âŒŠâŒœâ¥Š!<>`|Â¨Â´Ã·Ë™Ëœâ†‘â†“âˆ˜âˆ¾â‰ â‰¥âŠ¢âŠ£âŠ¸â‹†â‹ˆâŒˆâŸâŠâ—‹â—¶âŸœ"
isFull â† Â¬ primC âˆŠ "â¼âŠ/âŠ”âŒ¾â·âš‡Ë"
fullC â† isFull/primC
extraC â† pre (Â¬âˆ˜âˆŠËœ/âŠ¢) fullC
# â€¢Out List "bi_"âŠ¸âˆ¾Â¨ (primCâˆŠextraC) / primN

glyphs â† Import "glyphs.bqn"
_getComp â† { (4+2Ã—srcmap)â†‘ <âˆ˜âŠ¢âˆ¾Ëœ 5â†‘ (ğ•— Import "c.bqn"){ğ”½} }
Comp â† ((<"incG(runtime["âˆ¾Fâˆ¾"])"Ë™)Â¨â†•â‰ âˆ¾glyphs) glyphs _getComp âŠ¢
RT â† {
  ext â† 2=â‰ ğ•©
  ğ•© â†© âŠ‘ğ•©
  srcâ€¿needâ€¿inputsâ†((extâŠ‘ğ•©â€¿1) âˆ¾ ext/âŸ¨fullC, extraCâŸ©) Import "pr.bqn"
  prâ†"runtime_0"â€¿"provide"{(âˆ¾ğ•¨<âŠ¸(<âˆ˜{âˆ¾"incG("â€¿ğ•¨â€¿"["â€¿ğ•©â€¿"])"}âŸœFÂ¨)âŸœ(â†•â‰ )Â¨ğ•©)âŠËœ(âˆ¾ğ•©)âŠâˆ¾need}â—‹((-1+1=ğ•©)âŠ¸â†‘)inputs
  FmtComp pr need _getComp src
}
CArg â† {(@+10) Join (Â¯5âŠ¸â†“âˆ¾ğ•©Ë™)âŒ¾âŠ‘ FLines "c.bqn"}
SVG â† {âˆ¾âŸ¨"Modifyâ†GetHighlightsâ†âŠ¢â‹„"âŸ©âˆ¾ FCharsâˆ˜âˆ¾âŸœ".bqn"Â¨ "../svg"â€¿ğ•©}

LFC â† FmtCompâˆ˜Comp

(@+10)âˆ¾Ëœ â€¢OutâŸ(Â¬return) (âŠ‘"r"â€¿"r0"â€¿"r1"â€¿"r1x"â€¿"c"â€¿"cc"â€¿"f"â€¿"e"â€¿"eu"â€¿"p"âŠâŠ)â—¶âŸ¨
  RTâˆ˜2, RTâˆ˜0, RTâˆ˜1, RTâˆ˜1â€¿'x'
  {ğ•©â‹„LFC CArg "âŸ¨"âˆ¾"âŸ©"Â«âˆ¾","âŠ¸âˆ¾Â¨'"'(âŠ£âˆ¾âˆ¾Ëœ)Â¨glyphs}
  {ğ•©â‹„LFC "{"âˆ¾"}"âˆ¾ËœCArg"ğ•©"}
  {ğ•©â‹„LFC FChars "f.bqn"}
  {ğ•©â‹„LFC SVG "e"}
  {ğ•©â‹„LFC FChars "eu.bqn"}
  {ğ•©â‹„LFC SVG "p"}
  âˆ¾LFCÂ¨
âŸ© args