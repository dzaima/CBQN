chdir â† @â€¢FFI"i32"â€¿"chdir"â€¿">*u8:c8"
Split â† {ğ•©âŠ”Ëœ(âŠ¢-Ëœ+`Ã—Â¬)ğ•©=ğ•¨}
SimplifyPath â† {
  1â†“âˆ¾'/'âŠ¸âˆ¾Â¨ {(âˆŠÃ—Ã—) âŒŠ`âŒ¾âŒ½ +` Â¬âŠ¸- ".."âŠ¸â‰¡Â¨ğ•©}âŠ¸/ "."âŠ¸â‰¢Â¨âŠ¸/ '/'Splitğ•©
}
Good â† { ğ•Š dirâ€¿t0â€¿t1â€¿oâ€¿eâ€¿deps:
  âŸ¨1, oâˆ¾e, t1-t0, deps â‹ˆÂ¨ (â€¢file.Modified dirâ€¢file.AtâŠ¢)Â¨ depsâŸ©
}

_runSingeli_ â† { runArgs GetDeps _ğ•£_ dir runFile:
  t0 â† â€¢MonoTime@
  eâ†@ â‹„ depsâ†@
  {ğ•Š:
    runArgs â€¢Import runFile
    deps â†© GetDeps@
  }âŠ{ğ•Š: eâ†©â€¢CurrentError@} @
  t1 â† â€¢MonoTime@
  {
    eâ‰¢@? âŸ¨0, eâŸ©;
    Good âŸ¨dir,t0,t1,"","",depsâŸ©
  }
}

{
  "sh"â€¿dirâ€¿cmdâ€¿depf:
    t0 â† â€¢MonoTime@
    Chdir @âˆ¾Ëœ â€¢ToUTF8 dir
    câ€¿oâ€¿e â† â€¢SHâŠ{ğ•Š: âŸ¨'e',"",âˆ¾âŸ¨"Failed to run ", âŠ‘cmd, ": ", â€¢CurrentError@âŸ©âŸ©} cmd
    t1 â† â€¢MonoTime@
    {
      0: @â‰¡depf?
        Good âŸ¨dir,t0,t1,o,e,âŸ¨âŸ©âŸ©;
      0:
        deps â† â€¢FLines depf
        deps {ğ•©/Ëœ1Â»âˆ§`'\'=Â¯1âŠ‘âˆ˜â†‘Â¨ğ•©}â†©     # remove all but the initial rule
        deps {ğ•©â†“Ëœ1+âŠ‘ğ•©âŠ':'}âŒ¾âŠ‘â†©          # remove rule name
        deps Â¯1âŠ¸â†“Â¨âŒ¾(Â¯1â†“âŠ¢)â†©             # remove trailing backslashes
        deps ({ğ•©/ËœÂ¬âˆ§`ğ•©=' '}âŒ½)âŸ2Â¨â†©      # trim whitespace from both sides
        deps (âˆ¾' 'SplitÂ¨âŠ¢)â†©            # split each on spaces
        deps {Â¬âˆ¨Â´"/build/obj2/"â·ğ•©}Â¨âŠ¸/â†© # remove autogenerated dependencies, those are handled manually
        deps SimplifyPathÂ¨â†©            # remove "."s & ".."s
        deps {dir<â—‹â‰ ğ•©? dirâ‰¡(â‰ dir)â†‘ğ•©? (â‰ dir)â†“ğ•©; ğ•©}Â¨â†© # relativize
        Good âŸ¨dir,t0,t1,o,e,depsâŸ©;
      # câ‰ 0:
        âŸ¨0, oâˆ¾eâŸ©
    } c
  ;
  "singeli"â€¿dirâ€¿dstâ€¿singeliDirâ€¿argsâ€¿srcâ€¿dep:
    prefix â† "si_"âˆ¾ (âˆ§`'.'âŠ¸â‰ )âŠ¸/ â€¢file.Name src
    argsFinal â† argsâˆ¾âŸ¨"-d" â‹„ dep â‹„ "-o" â‹„ dst â‹„ "-n" â‹„ prefix â‹„ srcâŸ©
    argsFinal {ğ•Š: src<âŠ¸âˆ¾ SimplifyPathÂ¨ singeliDirâŠ¸â€¢file.AtÂ¨ â€¢FLines dep}_runSingeli_ dir singeliDir â€¢file.At "singeli"
  ;
  "runbqn"â€¿dirâ€¿fileâ€¿argsâ€¿deps:
    args deps _runSingeli_ dir file
  ;
    0â‹ˆ"unknown command"
}