âŸ¨AtRootâŸ© â† â€¢args
Escâ†{
  in â† (@+0â€¿9â€¿10â€¿13)âˆ¾"'"""   # Null, Tab, LF, CR, and quotes
  out â† "0tnr"               # Whitespace characters changed to letters
  i â† inâŠğ•©
  ğ•© â†© i âŠâŸœoutâŒ¾((i<â‰ out)âŠ¸/) ğ•© # Replace
  âˆ¾(i<â‰ in) /âŸœ"\"âŠ¸âˆ¾Â¨ ğ•©        # Insert \
}
nâ†@+10
JStr â† {âˆ¾âŸ¨"""",Esc ğ•©,""""âŸ©}
JArr â† {'['âˆ¾']'âˆ¾Ëœ2â†“âˆ¾ğ•¨âŠ¸âˆ¾Â¨ ğ•©}
JObj â† {âˆ¾âŸ¨'{',n,Â¯2â†“âˆ¾(JStrÂ¨ğ•¨) {âˆ¾âŸ¨"  ",ğ•¨,": ",ğ•©,',',nâŸ©}Â¨ ğ•©, n,'}'âŸ©}



precompFiles â† â¥Š"bytecodeLocal"â€¿"bytecodeSubmodule" {âˆ¾âŸ¨"../build/",ğ•¨,"/gen/",ğ•©âŸ©}âŒœ "compiles"â€¿"explain"â€¿"formatter"â€¿"runtime0"â€¿"runtime1"â€¿"runtime1x"
Files â‡ {
  res â† âŸ¨âŸ©
  {'d'=â€¢file.Type AtRoot ğ•©? ğ•ŠÂ¨ ğ•©âŠ¸â€¢file.AtÂ¨ â€¢file.List AtRoot ğ•©; resâˆ¾â†© <ğ•©} ğ•©
  {âŠ‘(<Â¯2â†‘ğ•©)âˆŠ".c"â€¿".h"}Â¨âŠ¸/ res
  res âˆ¾ ğ•©âŠ¸â€¢file.AtÂ¨ precompFiles
}

ModifyCBQNFlags â† {
  filenames â† 4â†“Â¨ âŠ‘Â¨ ğ•©
  flagKâ†âŸ¨âŸ©
  flagVâ†âŸ¨âŸ©
  WantsFlags â† {
    ğ•¨ â€¢file.Atâ†© # â‹„ â€¢Out ğ•¨âˆ¾" wants flags "âˆ¾JArr JStrÂ¨ ğ•©
    flagKâˆ¾â†© <ğ•¨
    flagVâˆ¾â†© <ğ•©
  }
  WantsIncludes â† {
    ğ•¨ WantsFlags âˆ¾ ("-include"â‹ˆ"src"â€¢file.AtâŠ¢)Â¨ ğ•©
  }
  
  FilterPrefix â† {ğ•¨âŠ¸{ğ•¨â‰¡(â‰ ğ•¨)â†‘ğ•©}Â¨âŠ¸/ ğ•©}
  
  # main core.h sequence, assuming MM==1
  coreIncludes â† âŸ¨"h.h","core/stuff.h","core/heap.h","opt/mm_buddy.h","core/gstack.h","core/harr.h","core/numarr.h","core/chrarr.h","core/fillarr.h","core/derv.h","core/arrFns.h"âŸ©
  {(Â¯1âŠ‘ğ•©) WantsIncludes Â¯1â†“ğ•©}Â¨ 2â†“â†‘ coreIncludes
  CoreTil â† {coreIncludesâ†‘ËœâŠ‘coreIncludesâŠ<ğ•©}
  
  # MM==0 and MM==2
  coreTilMM â† CoreTil "opt/mm_buddy.h"
  {ğ•© WantsIncludes coreTilMM}Â¨ "opt/mm_2buddy.h"â€¿"opt/mm_malloc.h"
  
  # non-'utils/' headers & optional .c files
  {ğ•© WantsIncludes âŸ¨"core.h"âŸ©}Â¨ âŸ¨
    "ns.h", "vm.h", "builtins.h", "load.h"
    "opt/mm_malloc.c", "opt/mm_buddyTemplate.h", "opt/gc.c", "opt/gc.h"
    "builtins/radix.h", "singeli/c/arithdDispatch.h"
    "jit/nvm.h"
  âŸ©
  # and all the utils/ onces
  {ğ•© WantsIncludes âŸ¨"core.h"âŸ©}Â¨ "utils/" FilterPrefix filenames
  # and some other things
  "core/tyarrTemplate.h" WantsIncludes CoreTil "core/chrarr.h"
  "core/tyarrTemplate.c" WantsIncludes âŸ¨"core/tyarr.c"âŸ©
  "builtins/grade.h" WantsIncludes âŸ¨"builtins/sort.c"âŸ©
  "singeli/c/arithdDispatch.c" WantsIncludes âŸ¨"builtins/arithd.c"âŸ©
  "singeli/c/cmp.c" WantsIncludes âŸ¨"builtins/cmp.c"âŸ©
  "utils/hashmapTemplate.h" WantsIncludes âŸ¨"utils/hash.h"âŸ©
  
  precompFiles WantsIncludesÂ¨ <âŸ¨"load.c"âŸ©
  precompFiles WantsFlagsÂ¨ <âŸ¨"-xc"âŸ©
  
  # give the expected environment for configuration-specific files
  "opt/mm_buddyTemplate.c"â€¿"opt/mm_buddy.c"â€¿"opt/mm_2buddy.c" WantsIncludesÂ¨ <âŸ¨"core/mm.c"âŸ©
  "opt/mm_malloc.h"â€¿"opt/mm_malloc.c" WantsFlagsÂ¨ <âŸ¨"-DMM=0"âŸ©
  "opt/mm_buddy.h" â€¿"opt/mm_buddy.c"  WantsFlagsÂ¨ <âŸ¨"-DMM=1"âŸ©
  "opt/mm_2buddy.h"â€¿"opt/mm_2buddy.c" WantsFlagsÂ¨ <âŸ¨"-DMM=2"âŸ©
  "utils/valgrind.h" WantsFlags âŸ¨"-DUSE_VALGRIND"âŸ©
  "core/heap.h" WantsFlags âŸ¨"-DHEAP_VERIFY"âŸ©
  {ğ•© WantsFlags âŸ¨"-DSINGELI"âŸ©}Â¨ "singeli/c/" FilterPrefix filenames
  
  # template files
  "builtins/sortTemplate.h" WantsIncludes âŸ¨"core.h", "utils/talloc.h"âŸ©
  "builtins/sortTemplate.h" WantsFlags âŸ¨"-DSORT_NAME=", "-DSORT_TYPE=B", "-DSORT_CMP=compare"âŸ©
  "opt/mm_buddyTemplate.c"â€¿"opt/mm_buddyTemplate.h" WantsFlagsÂ¨ <âŸ¨"-DBN(X)=mm_##X", "-DMMI(X)=X", "-DBSZ(X)=(1ull<<(X))", "-DALSZ=20", "-DMM=1"âŸ©
  
  # deduplicate flag files
  gfk â† â·flagK
  gfv â† âˆ¾Â¨ (âŠflagK) âŠ” flagV
  
  # resolve flags to actual files
  ğ•© {nâ€¿f ğ•Š f2: âŸ¨n, fâˆ¾âŸ¨"-Wno-undefined-internal", "-DCLANGD"âŸ©âˆ¾f2âŸ©}Â¨ (gfkâŠâ€¢file.AtÂ¨ filenames)âŠgfv âˆ¾ <âŸ¨âŸ©
}

objects â† âŸ¨âŸ©
Finish â‡ { ğ•Š write:
  objects ModifyCBQNFlagsâŒ¾(({"src/"â‰¡4â†‘âŠ‘ğ•©}Â¨ objects)âŠ¸/)â†©
  FileObj â† { nameâ€¿flags:
    "file"â€¿"directory"â€¿"arguments" JObj âŸ¨JStr name, JStr AtRoot "", ", " JArr JStrÂ¨ flagsâŸ©
  }
  res â† (","âˆ¾n) JArr FileObjÂ¨ objects
  {
    â€¢Out {write? "Removing"; "Would remove"} âˆ¾ " old "âˆ¾ğ•©
    â€¢file.RemoveâŸwrite ğ•©
  }âŸâ€¢file.Exists AtRoot "compile_commands.json"
  resPath â† AtRoot "build/compile_commands.json"
  {
    write?
      resPath â€¢FChars res
      â€¢Out "Wrote clangd compile commands to "âˆ¾â€¢file.At resPath
    ;
      â€¢Out "Would write clangd compile commands to "âˆ¾â€¢file.At resPath
  }
}
_add â‡ {objectsâˆ¾â†© <âŸ¨ğ•©, (ğ”½@)âˆ¾<ğ•©âŸ©}