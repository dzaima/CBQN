t0g â† â€¢MonoTime@
#!build/obj2/for_build
# todo:
#   clean
#   forcing bytecode/singeli/replxx directories to whatever's applicable

âŸ¨Spawn, WaitForOneâŸ© â† âŸ¨âŸ© â€¢Import "fork.bqn"
âŸ¨Serialize, DeserializeâŸ© â† â€¢Import "serialize.bqn"

# modes:
#  0: single string option
#  1: toggle
#  2: flag list
opts â† âŸ¨
  # makefile compatibility options:
  âŸ¨1, "from-makefile", 0, @âŸ©
  âŸ¨2, "LD_LIBS", @, @âŸ©
  âŸ¨1, "NO_LDL",  0, @âŸ©
  âŸ¨1, "no_fPIC", 0, @âŸ©
  
  âŸ¨0, "j",       @, "Number of parallel jobs"âŸ©
  âŸ¨1, "verbose", 0, "Log more things"âŸ©
  âŸ¨1, "rebuild", 0, "Forcibly rebuild everything"âŸ©
  âŸ¨1, "notui",   0, "disable live-updating status display"âˆ¾@+10âŸ©
  âŸ¨1, "rebuild-singeli", 0, @âŸ©
  
  âŸ¨0, "CC",    @, "The used C compiler"âŸ©
  âŸ¨0, "LD",    @, "Linker of the final binary; defaults to CC, or CXX if REPLXX=1"âŸ©
  âŸ¨1, "color", @, "Whether to enable colored diagnostics; default based on notui"âŸ©
  âŸ¨0, "os",    @, "Target OS (linux, bsd, macos)"âŸ© # used for .so vs .dylib, and changing linker flags for bsd
  âŸ¨0, "arch",  @, "Target architecture (x86-64, aarch64, generic)"âŸ© # used for selecting Singeli target
  âŸ¨1, "pie",   @, "Position-independent executable; default based on OS & arch"âˆ¾@+10âŸ©
  
  âŸ¨0, "OUTPUT",  "", "Output location; defaults to ./BQN for regular builds"âŸ©
  âŸ¨2, "f",       âŸ¨âŸ©, "C flags for CBQN files"âŸ©
  âŸ¨2, "CCFLAGS", âŸ¨âŸ©, "flags for all C compiler & linker invocations"âŸ©
  âŸ¨2, "lf",      âŸ¨âŸ©, "linker flags"âŸ©
  âŸ¨2, "sf",      âŸ¨âŸ©, "Singeli flags"âŸ©
  âŸ¨2, "LDFLAGS", âŸ¨âŸ©, @âŸ©
  âŸ¨2, "rm_f",    âŸ¨âŸ©, "forcibly remove C compiler flag(s)"âŸ©
  âŸ¨2, "rm_lf",   âŸ¨âŸ©, "forcibly remove linker flag(s)"âŸ©
  âŸ¨0, "v",       @,  "Version to report by --version; 'v=' to use git commit"âˆ¾@+10âŸ©
  
  âŸ¨1, "shared", 0, "Build a shared library; default output depends on 'os' setting"âŸ©
  âŸ¨1, "wasi",   0, "Build with WASI; default output name is BQN.wasm"âŸ©
  âŸ¨1, "emcc",   0, "Build with emscripten; outputs two files - BQN.wasm and BQN.js"âŸ©
  âŸ¨1, "clangd", 0, "Don't build, instead generate a compile_commands.json for clangd"âˆ¾@+10âŸ©
  
  âŸ¨1, "FFI",       @, "Enable FFI through libffi; On by default, except for WASM builds"âŸ©
  âŸ¨1, "pkgconfig", 1, "Attempt to use pkg-config to find libffi flags"âŸ©
  âŸ¨1, "singeli",   0, "Enable compilation with Singeli"âŸ©
  âŸ¨1, "replxx",    0, "Enable REPLXX"âˆ¾@+10âŸ©
  
  âŸ¨1, "c",      0, "Disable some default flags"âŸ©
  âŸ¨1, "O3",     @, "Use '-O3'; On by default unless 'c=1'"âŸ©
  âŸ¨1, "native", @, "Use '-march=native'"âˆ¾@+10âŸ©
  
  âŸ¨1, "debug",      0, "Debug: '-DDEBUG -g'; enables various sanity checks"âŸ©
  âŸ¨1, "g",          @, "Debug: '-g'; enable debug symbols"âŸ©
  âŸ¨1, "rtverify",   0, "Debug: compare builtin results with the self-hosted runtime"âŸ©
  âŸ¨1, "heapverify", 0, "Debug: check reference count correctness"âˆ¾@+10âŸ©
  
  âŸ¨0, "CXX", "c++", "C++ compiler (for replxx)"âŸ©
  âŸ¨2, "REPLXX_FLAGS", âŸ¨"-std=c++11", "-Os"âŸ©, "default replxx C++ build flags"âŸ©
âŸ©

Log â† â€¢Out
_verboseLog â† {ğ”½_ğ•£:âŠ¢}
onExitList â† âŸ¨âŸ©
OnExit â† {ğ•Š: {ğ•@}Â¨ onExitList}
_assert_ â† { ğ”¾ğ•©?ğ•©; Log ğ•¨ğ”½ğ•© â‹„ OnExit@ â‹„ â€¢Exit 1}

SepArgs â† {' ' ((Â¬-ËœâŠ¢Ã—Â·+`Â»âŠ¸>)âˆ˜â‰ âŠ”âŠ¢) ğ•©}
Lowercase â† {ğ•© - (-Â´"Aa")Ã—(ğ•©â‰¥'A')âˆ§ğ•©â‰¤'Z'}

getOpt â† {
  args â† Ã—âˆ˜â‰ Â¨âŠ¸/ â€¢args
  
  treq â† (argsâ‰¢Â¨<"v=") âˆ§ '='=Â¯1âŠ‘Â¨args
  compat â† âŠ‘(<"from-makefile") âˆŠ args
  {
    compat? args (Â¬treq)âŠ¸/ â†©; # makefile will leave things like "shared=" if the envvar was empty; build/build by default sees this as "shared=1", but we want to ignore it
    {ğ•Š: "Error: Trailing '=' for an option"} _assert_Â¬ âˆ¨Â´treq
  }
  
  [ot, on0, od, oh] â† â‰>opts
  on â† LowercaseÂ¨ on0
  
  {ğ•Š:
    â€¢Out "Usage: path/to/cbqn/build/build [options]
  Options are specified as arguments of 'key=value'. Keys are case-insensitive.
  Toggles without a value implicitly enable it; e.g. 'singeli' is 'singeli=1'.
  For flag lists, 'k=v' will split on spaces, i.e. 'f=-a -b' adds two flags,
  whereas 'f+=-a -b' adds one flag that contains a space.
Options:
"âˆ¾âˆ¾oh {"  "âˆ¾ğ•©âˆ¾"  "âˆ¾ğ•¨âˆ¾@+10}Â¨âŸœ((âŒˆÂ´â‰ Â¨)âŠ¸(â†‘Â¨))â—‹((@â‰¢Â¨oh)âŠ¸/) on0
    â€¢Exit 0
  }âŸâŠ¢ âˆ¨Â´ "help"â€¿"h"â€¿"?"âˆŠ'-'âŠ¸â‰ âŠ¸/Â¨ â€¢args
  
  ot1 â† 1=ot
  ot2 â† 2=ot
  s1 â† âŠ‘âˆ˜âŠâŸœ'='Â¨ args # start of =
  hs â† s1<â‰ Â¨args     # has value
  fl â† hsâˆ§'+'=(0âŒˆs1-1)âŠ‘Â¨args # is appended flag, i.e. "f+=a b c"
  s0 â† s1-fl         # end of key
  ks â† s0â†‘Â¨args      # keys
  ks LowercaseÂ¨â†©     # lowercase keys
  vs â† (1+s1)â†“Â¨args  # values
  {ğ•Š: âˆ¾âŸ¨"Unknown option -- '",âŠ‘(Â¬ksâˆŠon)/ks, "'; see --help for options"âŸ©}_assert_(âˆ§Â´) ksâˆŠon
  
  ci â† onâŠks # index in option specification
  {ğ•Š: âˆ¾âŸ¨"Error: Unexpected '+=' for '",ksâŠ‘ËœâŠ‘/Â¬ğ•©,"'"âŸ©}_assert_(âˆ§Â´) (ciâŠot2)âˆ¨Â¬fl
  
  Gr â† {(â‰ ot)â†‘ciâŠ”ğ•©}
  gvs â† Gr vs # values for each option
  {ğ•Š: âˆ¾âŸ¨"Error: Multiple values given for '",onâŠ‘ËœâŠ‘/Â¬ğ•©,"'"âŸ©}_assert_(âˆ§Â´) ot2âˆ¨1â‰¥â‰ Â¨gvs
  
  {ğ•Š: âˆ¾âŸ¨"Error: Expected value to be provided for ",âŠ‘ğ•©/ksâŸ©}_assert_(Â¬âˆ¨Â´) (Â¬ciâŠot1) âˆ§ Â¬hs
  
  # f='a b' f+='c d' â†’ "a" "b" "c d"
  gvs â†© (Gr fl) (âˆ¾{ğ•¨?â‹ˆğ•©;Ã—â‰ ğ•©?SepArgs ğ•©;â‹ˆâŸ¨âŸ©}Â¨)Â¨âŒ¾(ot2âŠ¸/) gvs
  # map toggles to their actual values, error on invalid
  gvs â†© on {ğ•¨{ğ•Š: âˆ¾âŸ¨"Error: Invalid value for '",ğ•¨,"'"âŸ©}_assert_âŠ¢ âˆ§Â´ğ•©âˆŠ""â€¿"0"â€¿"1" â‹„ â‰ â—¶âŠ¢â€¿(â‹ˆ"0"â‰¢âŠ‘) ğ•©}Â¨âŒ¾(ot1âŠ¸/) gvs
  
  gvs â†© ((Â¬ot2) â‹ˆâˆ˜âŠ¢âŸâŠ£Â¨ od) {Ã—â‰ ğ•©?ğ•©;ğ•¨}Â¨ gvs # map in defaults
  
  gvs â†© (Â¬ot2) â‹ˆâ¼âˆ˜âŠ¢âŸâŠ£Â¨ gvs # disclose options with only one expected result
  
  # â€¢Show [ks, fl, hs, ci, vs]
  # â€¢Show {ğ•©/ËœÃ—(â‰ 1âŠ‘âŠ¢)Ë˜ğ•©} â‰[on, gvs]
  {(âŠ‘onâŠ<Lowercase ğ•©)âŠ‘gvs}
}

SH â† {
  câ€¿oâ€¿e â† â€¢SHâŠ{ğ•Š: ğ•© {ğ•Š: âˆ¾âŸ¨"Error: Failed to spawn ",âŠ‘ğ•¨âŸ©}_assert_âŠ¢ 0} ğ•©
  LogâŸ(Ã—â‰ ) e
  ğ•© {ğ•Š: âˆ¾âŸ¨"Error: ",âŠ‘ğ•¨," exited with error code ",â€¢Repr ğ•©âŸ©}_assert_(0=âŠ¢) c
  o
}
TrySH â† {1âŠ‘â€¢SHâŠ1â€¿ğ•¨â€¿"" ğ•©}

rootDir â† â€¢file.ParentâŸ2 â€¢file.path
AtRoot â† rootDirâŠ¸â€¢file.At

po â† { # parsed options
  âŸ¨
    verbose, J, rebuildAll, rebuildSingeli, tui, output, clangd, versionName,
    os, arch, native,
    emcc, wasm, replxx, singeli,
    ffi, o3,
    bytecodeDir, replxxDir, singeliDir,
    CBQNc, ccColor, singeliFlags, REPLXXc, Linker
  âŸ©â‡
  
  compat â† GetOpt "from-makefile"
  custom â† GetOpt "c"
  clangd â† GetOpt "clangd"
  DOpt â† {@âŠ¸â‰¡â—¶âŸ¨âŠ¢,ğ•¨âŸ© GetOpt ğ•©}
  J â‡ {ğ•Š: vâ†GetOpt "j" â‹„ vâ‰¢@? â€¢ParseFloat v; â€¢ParseFloatâŠ4 "4" TrySH âŸ¨"nproc"âŸ©}
  rebuildAll â‡ GetOpt "rebuild"
  rebuildSingeli â‡ GetOpt "rebuild-singeli"
  tui â‡ Â¬GetOpt "notui"
  {ğ•Š: _verboseLog â†© {Logğ•¨ğ”½ğ•©â‹„ğ•©}}âŸâŠ¢ verboseâ‡GetOpt "verbose"
  
  Max1 â† {ğ•© {ğ•Š: aâ€¿bâ†2â†‘ğ•©/ğ•¨ â‹„ âˆ¾âŸ¨"Error: '",a,"' and '",b,"' cannot both be enabled"âŸ©}_assert_(1â‰¥+Â´) GetOptÂ¨ ğ•©}
  Max1 "REPLXX"â€¿"shared"â€¿"wasi"â€¿"emcc"
  
  
  shared â† GetOpt "shared"
  native â‡ 0 DOpt "native"
  emcc â‡ GetOpt "emcc"
  wasi â† GetOpt "wasi"
  versionName â† {compat âˆ§ shared? @; "0"âŠ¸â‰¡â—¶âŠ¢â€¿@ GetOpt "v"}
  {ğ•Š: "Error: Specifying version for shared build is useless"}_assert_Â¬ shared âˆ§ versionNameâ‰¢@
  wasm â‡ wasiâˆ¨emcc
  
  cc â† {emcc? "emcc"; "clang"} DOpt "CC"
  cxx â† GetOpt "CXX"
  debug â† GetOpt "debug"
  o3 â‡ (Â¬custom) DOpt "O3"
  
  uname â† âŠ¢â—¶""â€¿{ğ•Š: Lowercase "" TrySH "uname"â€¿"-sm"} âˆ§Â´ (@â‰¡GetOpt)Â¨ "os"â€¿"arch"
  InUname â† {ğ•Š: âˆ¨Â´ ğ•©â·uname}
  
  os â‡ Lowercase {InUname"linux"? "linux"; InUname"darwin"? "macos"; InUname"bsd"? "bsd"; "linux"} DOpt "os"
  linuxâ€¿bsdâ€¿macosâ€¿windows â† osâŠ¸â‰¡Â¨ {ğ•Š: "Error: Unsupported OS; options:"âˆ¾1â†“âˆ¾", "âŠ¸âˆ¾Â¨ğ•©}_assert_(âŠ‘os<âŠ¸âˆŠâŠ¢) "linux"â€¿"bsd"â€¿"macos"â€¿"windows"
  
  arch â‡ {'-'Â¨âŒ¾(('_'=ğ•©)âŠ¸/)ğ•©} Lowercase {InUname"x86_64"? "x86-64"; âˆ¨Â´InUnameÂ¨"aarch64"â€¿"arm64"? "aarch64"; "generic"} DOpt "arch"
  {ğ•Š: "Error: Unsupported arch; options:"âˆ¾1â†“âˆ¾", "âŠ¸âˆ¾Â¨ğ•©}_assert_(âŠ‘arch  <âŠ¸âˆŠâŠ¢) "x86-64"â€¿"aarch64"â€¿"generic"
  
  ffi â‡ ((Â¬windows)âˆ§Â¬wasm) DOpt "FFI"
  singeli â‡ GetOpt "singeli"
  replxx â‡ GetOpt "REPLXX"
  
  {ğ•Š: "Error: Cannot use Singeli on x86-64 without explicit 'native'"}_assert_Â¬ (archâ‰¡"x86-64") âˆ§ singeli âˆ§ @â‰¡GetOpt"native"
  {ğ•Š: "Error: Cannot use Singeli on generic arch"}_assert_Â¬ singeli âˆ§ archâ‰¡"generic"
  
  pie â‡ {(Â¬shared)âˆ§linuxâˆ§archâ‰¡"x86-64"? 0; 1} DOpt "pie"
  
  output â‡ GetOpt "OUTPUT"
  output â†© â€¢wdpathâ€¢file.At {ğ•Š:
    wasi? "BQN.wasm";
    emcc? ".";
    shared? {macos? "libcbqn.dylib"; windows? "cbqn.dll"; "libcbqn.so"};
    windows? "BQN.exe";
    "BQN"
  }âŸ(""â‰¡âŠ¢) output
  
  exportSymbols â† ffiâˆ¨shared
  
  defLibs â† @â‰¡GetOpt "LD_LIBS"
  GetLibs â† { ğ•Š:
    getLibs â†© âŸ¨âŸ©âŒ¾(1âŠ¸âŠ‘)âŸ(Â¬defLibs) {
      Â¬ffi? âŸ¨âŸ¨âŸ©,âŸ¨âŸ©âŸ©;
      GetOpt "pkgconfig"? 0=âŠ‘ â€¢SHâŠ1 "pkg-config"â€¿"--exists"â€¿"libffi"?
        {SepArgs Â¯1â†“SHâŸ¨"pkg-config",ğ•©,"libffi"âŸ©}Â¨ âŸ¨"--cflags", "--libs"âŸ©;
      âŸ¨âŸ¨âŸ©, âŸ¨"-lffi"âŸ©âŸ©
    }
  }
  
  SubmoduleDir â† "build"âŠ¸â€¢file.AtâŸ(@â‰¢âŠ¢) {ğ•¨â‰¡0?@; â€¢file.Exists râ†AtRoot "build"â€¢file.At ğ•©âˆ¾"Local"? r; ğ•©âˆ¾"Submodule"}
  LogDir â† {ğ•©â‰¡@? ğ•¨âˆ¾": not used"; ğ•¨âˆ¾" directory: "âˆ¾AtRoot ğ•©}_verboseLog
  bytecodeDir â‡ 1       SubmoduleDir "bytecode" â‹„ "Bytecode" LogDir bytecodeDir
  replxxDir   â‡ replxx  SubmoduleDir "replxx"   â‹„ "REPLXX" LogDir replxxDir
  singeliDir  â‡ singeli SubmoduleDir "singeli"  â‹„ "Singeli" LogDir singeliDir
  {ğ•Š: "Output location: "âˆ¾ğ•©}_verboseLog output
  
  ccClang â† {clangd? 1; âˆ¨Â´"clang"â·SH ccâ€¿"--version"}
  ccColor â‡ ((Â¬clangd) âˆ§ tui DOpt "color") / âŸ¨ccClangâŠ‘"-fdiagnostics-color=always"â€¿"-fcolor-diagnostics"âŸ©
  
  cbqnc â† {
    args â† âŸ¨
      cc,
      "-std=gnu11",
      "-Wall", "-Wno-unused-function",
      "-fms-extensions", "-ffp-contract=off", "-fno-math-errno", "-fvisibility=hidden", "-fno-strict-aliasing",
      "-DBYTECODE_DIR="âˆ¾â€¢file.Name bytecodeDir,
      "-DSINGELI="âˆ¾â€¢Repr singeli,
      "-DFFI="âˆ¾â€¢Repr 2Ã—ffi
    âŸ©
    argsâˆ¾â†© ccClangâŠ‘âŸ¨
      âŸ¨"-Wno-parentheses"âŸ©
      âŸ¨"-Wno-microsoft-anon-tag", "-Wno-bitwise-instead-of-logical", "-Wno-unknown-warning-option"âŸ©
    âŸ©
    argsâˆ¾â†© 0âŠ‘GetLibs@
    
    
    argsâˆ¾â†© GetOpt "f"
    argsâˆ¾â†© GetOpt "CCFLAGS"
    argsâˆ¾â†© (singeliâˆ§archâ‰¡ "x86-64") / âŸ¨"-DSINGELI_X86_64"âŸ©
    argsâˆ¾â†© (singeliâˆ§archâ‰¡"aarch64") / âŸ¨"-DSINGELI_NEON"âŸ©
    argsâˆ¾â†© (              wasm) / âŸ¨"-DWASM"âŸ©
    argsâˆ¾â†© (              wasi) / âŸ¨"-DWASI", "-DNO_MMAP", "-DCATCH_ERRORS=0", "-D_WASI_EMULATED_MMAN", "--target=wasm32-wasi"âŸ©
    argsâˆ¾â†© (              emcc) / âŸ¨"-DEMCC", "-O3"âŸ©
    argsâˆ¾â†© (            replxx) / âŸ¨"-DUSE_REPLXX", "-DREPLXX_STATIC=1", "-I"âˆ¾replxxDirâˆ¾"/include"âŸ© # TODO maybe move to main.c only, and have it be in its own separate cache dir, so that adding replxx doesn't recompile everything?
    argsâˆ¾â†© (    debug DOpt "g") / âŸ¨"-g"âŸ©
    argsâˆ¾â†© (                o3) / âŸ¨"-O3"âŸ©
    argsâˆ¾â†© (            native) / âŸ¨"-march=native"âŸ©
    argsâˆ¾â†© (             debug) / âŸ¨"-DDEBUG"âŸ©
    argsâˆ¾â†© ( GetOpt "rtverify") / âŸ¨"-DRT_VERIFY", "-DEEQUAL_NEGZERO"âŸ©
    argsâˆ¾â†© (GetOpt"heapverify") / âŸ¨"-DHEAP_VERIFY"âŸ©
    argsâˆ¾â†© (     exportSymbols) / âŸ¨"-DCBQN_EXPORT"âŸ©
    argsâˆ¾â†© (              Â¬pie) / âŸ¨"-fno-pie"âŸ©
    argsâˆ¾â†© (     pie âˆ§ Â¬shared) / âŸ¨"-fPIE"âŸ©
    argsâˆ¾â†© (            shared) / âŸ¨"-DCBQN_SHARED"âŸ© âˆ¾ (Â¬GetOpt"no_fPIC")/âŸ¨"-fPIC"âŸ©
    argsâˆ¾â†© (           windows) / âŸ¨"-DNO_MMAP"âŸ©
    argsâˆ¾â†© (  replxx âˆ§ windows) / âŸ¨"-DUSE_REPLXX_IO"âŸ©
    argsâˆ¾â†© (     @â‰¢versionName) / âŸ¨"-DHAS_VERSION"âŸ©
    args â†© args (Â¬âˆ˜âˆŠ/âŠ£) GetOpt "rm_f"
    {"CBQN C compiler: "âˆ¾â€¢Repr ğ•©} _verboseLog args
    args
  }
  
  REPLXXc â‡ { ğ•Š:
    args â† âŸ¨cxx, "-DREPLXX_STATIC=1", "-I"âˆ¾replxxDirâˆ¾"/include"âŸ©
    argsâˆ¾â†© GetOpt "REPLXX_FLAGS"
    argsâˆ¾â†© (         Â¬pie) / âŸ¨"-fno-pie"âŸ©
    argsâˆ¾â†© (pie âˆ§ Â¬shared) / âŸ¨"-fPIE"âŸ©
    argsâˆ¾â†© (       shared) / (Â¬GetOpt"no_fPIC")/âŸ¨"-fPIC"âŸ©
    {"REPLXX C++ compiler: "âˆ¾â€¢Repr ğ•©} _verboseLog args
    replxxc â†© args
  }
  
  singeliFlags â† GetOpt "sf"
  
  Linker â‡ { ğ•Š:
    rdynamic â† exportSymbols âˆ§ Â¬windows
    args â† âŸ¨{replxx? cxx; cc} DOpt "LD"âŸ©
    argsâˆ¾â†© defLibs / âŸ¨"-lm"âŸ©
    argsâˆ¾â†© âŸ¨âŸ© DOpt "LD_LIBS"
    argsâˆ¾â†© ((Â¬GetOpt "NO_LDL") âˆ§ defLibs âˆ§ ffi âˆ§ Â¬bsd) / âŸ¨"-ldl"âŸ©
    argsâˆ¾â†© 1âŠ‘GetLibs@
    argsâˆ¾â†© GetOpt "lf"
    argsâˆ¾â†© GetOpt "CCFLAGS"
    argsâˆ¾â†© GetOpt "LDFLAGS"
    argsâˆ¾â†© (         wasi) / âŸ¨"-lwasi-emulated-mman", "--target=wasm32-wasi", "-Wl,-z,stack-size=8388608", "-Wl,--initial-memory=67108864"âŸ©
    argsâˆ¾â†© (         emcc) / âŸ¨"-s", "EXPORTED_FUNCTIONS=_main,_cbqn_runLine,_cbqn_evalSrc", "-s", "EXPORTED_RUNTIME_METHODS=ccall,cwrap", "-s", "ALLOW_MEMORY_GROWTH=1"âŸ©
    argsâˆ¾â†© (     rdynamic) / âŸ¨"-rdynamic"âŸ©
    argsâˆ¾â†© (         Â¬pie) / âŸ¨"-no-pie"âŸ©
    argsâˆ¾â†© (pie âˆ§ Â¬shared) / âŸ¨"-fPIE", "-pie"âŸ©
    argsâˆ¾â†© (       shared) / âŸ¨"-shared"âŸ©
    argsâˆ¾â†© (      windows) / âŸ¨"-lpthread"âŸ©
    args â†© args (Â¬âˆ˜âˆŠ/âŠ£) GetOpt "rm_lf"
    {"linker: "âˆ¾â€¢Repr ğ•©} _verboseLog args
    linker â†© args
  }
  
  {ğ•Š: CBQNc@ â‹„ REPLXXcâŸreplxx @ â‹„ Linker@}âŸâŠ¢ verbose
}

Hash â† {(32â†‘âˆ¾"0a"+â†•Â¨10â€¿26)âŠËœ{ğ•¨+2Ã—ğ•©}Ë5â€¿âŒŠâ¥Š32â€¿1â€¢bit._castâˆ¾(â†•4)â€¢HashÂ¨<ğ•©}

MkDir â† {â€¢file.Existsğ•©?@; â€¢file.CreateDirğ•©}

allObjDir â† "build/obj2"
MkDir AtRoot allObjDir

isFileTheSame â† {
  ksâ€¿vs â† âŸ¨âŸ©â€¿âŸ¨âŸ©
  {
    i â† âŠ‘ksâŠ<ğ•¨
    i<â‰ ks? ğ•© â‰¡ iâŠ‘vs;
    ksâˆ¾â†© <ğ•¨
    vsâˆ¾â†© <tâ†â€¢file.ModifiedâŠ"unknown" ğ•¨
    ğ•© â‰¡ t
  }
}
GitCmd â† {
  Â¯1â†“SH âŸ¨"git", "-C", rootDirâŸ©âˆ¾ğ•©
}
updateSubmodule â† {
  done â† âŸ¨âŸ©
  {
    ğ•©â‰¡@? @;
    "Local"â‰¡Â¯5â†‘ğ•©? @;
    âŠ‘ğ•©<âŠ¸âˆŠdone? @;
    doneâˆ¾â†© <ğ•©
    GitCmd âŸ¨"submodule", "update", "--init", AtRoot ğ•©âŸ©
  }
}

# gets/creates a directory of cacheable objects; key is the unique identifier of when it can be reused
GetCache â† { ğ•Š basenameâ€¿descâ€¿key:
  folderHash â‡ Hash key
  folder â‡ allObjDirâ€¢file.At basenameâˆ¾"-"âˆ¾folderHash
  MkDir AtRoot folder
  
  File â‡ folderâŠ¸â€¢file.At
  {ğ•Š: descâˆ¾": "âˆ¾AtRootğ•©} _verboseLog folder
  
  dataPath â† AtRoot File "data"
  dataVersion â† 0
  prevKsâ€¿prevVs â† {aâ€¿b: aâ‰¡dataVersion? b; âŸ¨âŸ©â€¿âŸ¨âŸ©} â€¢file.Existsâ—¶âŸ¨@, {Deserialize âŸ¨8â€¿'c',8âŸ©â€¢bit._cast â€¢FBytes ğ•©}âŸ© dataPath
  
  Find â‡ {
    i â† âŠ‘prevKsâŠ<ğ•©.cacheKey
    i<â‰ prevKs? iâŠ‘prevVs;
    @
  }
  IsUpToDate â‡ {
    ğ•Š:
      ğ•©.found0â‰¢@?
      fileInfoâ€¿depInfo â† ğ•©.found0
      fileInfoâ‰¢@?
      âˆ§Â´ AtRootâŠ¸IsFileTheSameÂ´Â¨ fileInfo?
      depInfoâ‰¡ğ•©.DepHash@
    ;
      0
  }
  newKsâ€¿newVs â† âŸ¨âŸ©â€¿âŸ¨âŸ©
  finalNewData â† @
  FinalData â‡ { ğ•Š:
    finalNewDataâ‰¢@?finalNewData;
    jKs â† prevKsâˆ¾Ëœ {ğ•©.cacheKey}Â¨ newKs
    jVs â† prevVsâˆ¾Ëœ newKs {ğ•¨.SetVal ğ•©}Â¨ newVs
    finalNewData â†© Serialize dataVersionâ‹ˆ (<âˆŠjKs) /Â¨ jKsâ€¿jVs
  }
  Update â‡ {keyğ•Šdata: # dataâ‰¡@ means failed to build
    !finalNewDataâ‰¡@
    newKsâˆ¾â†© <key
    newVsâˆ¾â†© <data
  }
  onExitListâˆ¾â†© {{ğ•Š: dataPath â€¢FBytes âŸ¨8,8â€¿'c'âŸ©â€¢bit._cast FinalData@}âŸ{ğ•Š: 0â‰ â‰ newKs}}
}

ruleKsâ€¿ruleVs â† âŸ¨âŸ©â€¿âŸ¨âŸ©

# dependency resolution & thread management
Run â† { ğ•Š:
  ruleDeps â† {{ğ•©.dst}Â¨ ğ•©.ruleDeps}Â¨ ruleVs
  ruleSrcs0 â† ruleKsâŠâˆ¾ruleDeps
  ! âˆ§Â´ ruleSrcs0<â‰ ruleKs
  ruleSrcs â† ((â‰ âˆ¾Ëœâ‰ Â¨/â†•âˆ˜â‰ )ruleDeps) âŠ” ruleSrcs0
  req â† âŸ¨âŸ©
  ruleN â† 0Â¨ ruleKs # number of children (i.e. how many have this in their ruleP list)
  ruleP â† âŸ¨âŸ©Â¨ ruleKs # parent rules (i.e. which ones require this)
  
  Require â† {
    v â† ğ•©âŠ‘ruleVs
    rebuild â† po.rebuildAll
    {ğ•Š: rebuildâˆ¨â†© ".singeli"â‰¡Â¯8â†‘v.disp}âŸâŠ¢ po.rebuildSingeli
    chi â† ğ•©âŠ‘ruleSrcs
    chr â† RequireÂ¨ chi
    rebuildâˆ¨â†© âˆ¨Â´ chr
    # rebuildâˆ¨â†© Â¬â€¢file.Exists AtRoot ğ•©âŠ‘ruleKs # not really needed unless someone deletes a specific file without deleting the data file
    rebuildâˆ¨â†© Â¬v.cache.IsUpToDate v
    {
      ruleN (+Â´chr)âŠ¸+âŒ¾(ğ•©âŠ¸âŠ‘)â†©
      ruleP âˆ¾âŸœğ•©Â¨âŒ¾((chr/chi)âŠ¸âŠ)â†©
      reqâˆ¾â†© ğ•©
    }âŸrebuild ğ•©
    rebuild
  }
  anyRebuilt â† Require âŠ‘ruleKsâŠ<ğ•©
  
  left â† (reqâŠruleN=0)/req
  
  RequestJob â† { ğ•Š:
    0=â‰ left? @;
    (leftâ†“Ëœâ†© Â¯1) âŠ¢ Â¯1âŠ‘left
  }
  
  FinishJob â† { iğ•Štb:
    v â† iâŠ‘ruleVs
    LogâŸ(Ã—â‰ ) 1âŠ‘tb
    âŠ¢â—¶âŸ¨
      { ğ•Š:
        v v.cache.Update @
      }
      { ğ•Š:
        v v.cache.Update 3âŠ‘tb
        ps â† iâŠ‘ruleP
        ruleN -âŸœ1âŒ¾(psâŠ¸âŠ)â†©
        leftâˆ¾â†© (0=psâŠruleN)/ps
      } 
    âŸ© âŠ‘tb
    âŠ‘tb
  }
  
  threads â† Spawnâˆ˜(â€¢file.At "runner.bqn")Â¨ â†•{0:0; ğ•©âŒŠpo.J@} â‰ req
  work â† âŸ¨âŸ©
  free â† threads
  Ts â† {ğ•©.t}Â¨
  
  updateLive â† { ğ•Š:
    storedOut â† âŸ¨âŸ©
    Log â†© {storedOutâˆ¾â†© <ğ•©âˆ¾@+10}
    currLive â† âŸ¨âŸ©
    e â† @+27
    {
      â€¢term.OutRaw (Â¯4â†“âˆ¾(â‰ currLive)â¥Š<(eâˆ¾(@+13)âˆ¾"[0K"âˆ¾eâˆ¾"[1F")) âˆ¾ (â€¢ToUTF8 âˆ¾storedOut) âˆ¾ 1â†“âˆ¾((@+10)âˆ¾â€¢ToUTF8)Â¨ ğ•©
      â€¢term.Flush @
      currLive â†© ğ•©
      storedOut â†© âŸ¨âŸ©
    }
  }âŸpo.tui 0
  FmtTime â† {{(""â‰¡â—¶âŠ¢â€¿"0" Â¯1â†“ğ•©)âˆ¾'.'âˆ¾Â¯1â†‘ğ•©} â€¢Repr âŒŠ0.5+ 10Ã—ğ•©}
  onExitListâˆ¾â†© {{ğ•Š: UpdateLive âŸ¨âŸ©}}
  
  tmap â† âŸ¨âŸ© # threads in the order they're displayed on-screen (dynamically calculated so that if there's only ever only one job in parallel, there are no pointless empty lines)
  doneCount â† 0
  stopping â† 0
  Fail â† {stoppingâ†©1 â‹„ Log ğ•©}
  nextRedraw â† Â¯âˆ
  DoneLine â† {ğ•Š: âˆ¾âŸ¨â€¢Repr doneCount, "/", â€¢Repr â‰ reqâŸ©}
  { ğ•Š:
    {ğ•Š:
      t â† Â¯1âŠ‘free â‹„ freeâ†“Ëœâ†© Â¯1
      
      i â† RequestJob@ â‹„ vâ†iâŠ‘ruleVs
      t.Request v.CMD@
      workâˆ¾â†© {tâ‡t, iâ‡i, vâ‡v, t0â‡â€¢MonoTime@}
      
    }â€¢_while_{ğ•Š: âˆ§Â´0<â‰ Â¨ leftâ€¿free}âŸÂ¬ stopping
    
    t1 â† â€¢MonoTime@
    tmap â†© â·tmapâˆ¾Ts work
    FileLine â† {âˆ¾âŸ¨"[", FmtTime t1-ğ•©.t0, "] ", ğ•©.v.dispâŸ©}
    { ğ•Š:
      nextRedraw â†© t1+0.1
      UpdateLive (<DoneLine@)âˆ¾{
        ğ•©â‰¡â‰ work? "";
        FileLine ğ•©âŠ‘work
      }Â¨ (Ts work) âŠtmap
    }âŸâŠ¢ t1>nextRedraw-0.02
    
    dm â† (0.1âŒŠnextRedraw-t1) WaitForOne Ts work
    lm â† Â¬dm
    {ğ•Š: Fail "Error: Fork died" â‹„ dmâ€¿lmâˆ§â†©<dmâ‰ Â¯1}âŸâŠ¢ âˆ¨Â´dm=Â¯1
    done â† dm/work
    work â†© lm/work
    {
      ğ•©.i FinishJob ğ•©.t.Take@?
        {ğ•Š: Log FileLine ğ•© â‹„ â€¢term.Flush@}âŸ(Â¬po.tui) ğ•©
        doneCount+â†©1;
      Fail "Error: During '"âˆ¾ğ•©.v.dispâˆ¾"'"
    }Â¨ done
    freeâˆ¾â†© Ts done
  }â€¢_while_{ğ•Š: (0<â‰ work) âˆ¨ (Â¬stopping)âˆ§0<â‰ left}@
  
  Log âˆ¾âŸ¨DoneLine@, " in ", FmtTime t0g-Ëœâ€¢MonoTime@, "s", stopping/"; failed to build"âŸ©
  
  Â¬stopping
}


AddRule â† { ğ•Š cacheâ€¿cacheKeyâ€¿dstâ€¿GetCMDâ€¿dispâ€¿deps:
  ruleKsâˆ¾â†© <dst
  setFound â† @
  res â† {
    dst â‡ dst
    cache â‡ cache
    cacheKey â‡ cacheKey
    found0 â‡ 0
    SetFound â†© {found0â†©ğ•©}
    DepHash â‡ {ğ•Š: Hash {ğ•©.found1â‰¡@? ğ•©.found0; ğ•©.found1}Â¨ ruleDeps} # todo instead of conditionally choosing found1 or found2, decide statically; and properly cache
    found1 â‡ @
    SetVal â‡ {found1 â†© ğ•©â‹ˆDepHash@}
    disp â‡ disp
    CMD â‡ GetCMD
    ruleDeps â‡ deps
  }
  SetFound cache.Find res
  ruleVsâˆ¾â†© res
  res
}

clangd â† {Â¬po.clangd? {_addâ‡{ğ•¨ğ”½_ğ•£ğ•©:@} â‹„ Filesâ‡âŠ£}; âŸ¨AtRootâŸ© â€¢Import "clangd.bqn"}

MakeCCInv â† { ğ•Š GetArgsâ€¿Initâ€¿cacheâ€¿idâ€¿srcâ€¿customDeps: # src should be CBQN-base-dir-relative, so that cache doesn't store full paths
  GetArgs clangd._add src
  dst â† cache.File idâˆ¾".o"
  GetCMD â† { ğ•Š:
    Init @
    dep â† AtRoot cache.File idâˆ¾".d"
    âŸ¨"sh", rootDir, (GetArgs@)âˆ¾âŸ¨"-MT", "o", "-MMD", "-MF", dep, "-o", AtRoot dst, "-c", srcâŸ©, depâŸ©
  }
  AddRule âŸ¨cache, id, dst, GetCMD, â€¢file.Name src, customDepsâŸ©
}

MakeSingeliInv â† { ğ•Š argsâ€¿Initâ€¿cacheâ€¿idâ€¿srcâ€¿customDeps: # src should be CBQN-base-dir-relative, so that cache doesn't store full paths
  dst â† cache.File idâˆ¾".c"
  GetCMD â† { ğ•Š:
    Init @
    dep â† AtRoot cache.File idâˆ¾".d"
    âŸ¨"singeli", rootDir, AtRoot dst, AtRoot po.singeliDir, args, AtRoot src, depâŸ©
  }
  AddRule âŸ¨cache, id, dst, GetCMD, â€¢file.Name src, customDepsâŸ©
}

MakeLinkerInv â† { ğ•Š GetArgsâ€¿cacheâ€¿nameâ€¿srcs:
  dst â† cache.File name
  GetCMD â† { ğ•Š:
    args â† GetArgs@
    âŸ¨"sh", rootDir, âŸ¨âŠ‘args, "-o", dstâŸ©âˆ¾({ğ•©.dst}Â¨ srcs)âˆ¾1â†“args, @âŸ©
  }
  AddRule âŸ¨cache, name, dst, GetCMD, "link", srcsâŸ©
}



# actual CBQN/Singeli/REPLXX definitions
cachedBinâ€¿linkerCache â† {
  Shorten â† {po.clangd? ğ•©; r â† {ğ•©â†“ËœÂ¯1-âŠ‘'.'âŠËœâŒ½ğ•©}Â¨ â€¢file.NameÂ¨ ğ•© â‹„ ! âˆ§Â´ âˆŠr â‹„ r}
  cbqnSrc â† âˆ¾{âŒ½(âŠ‘ğ•©)âŠ¸â€¢file.AtÂ¨ 1â†“ğ•©}Â¨ âŒ½âŸ¨
    âŸ¨"src/builtins/", "arithd.c", "arithm.c", "cmp.c", "sfns.c", "squeeze.c", "select.c", "slash.c", "group.c", "sort.c", "search.c", "selfsearch.c", "transpose.c", "fold.c", "scan.c", "md1.c", "md2.c", "fns.c", "sysfn.c", "internal.c", "inverse.c"âŸ©
    âŸ¨"src/core/", "tyarr.c", "harr.c", "fillarr.c", "stuff.c", "derv.c", "mm.c", "heap.c"âŸ©
    âŸ¨"src/", "load.c", "main.c", "rtwrap.c", "vm.c", "ns.c", "nfns.c", "ffi.c"âŸ©
    âŸ¨"src/jit/", "nvm.c"âŸ©
    âŸ¨"src/utils/", "ryu.c", "utf.c", "hash.c", "file.c", "mut.c", "each.c", "bits.c"âŸ©
  âŸ©
  cbqnSrc â†© cbqnSrc clangd.Files "src"
  singeliMap â† 1â†“Â¨ (âˆ¨Â´Â¨ (âŠ‘po.arch) = âŠ‘Â¨)âŠ¸/ âŸ¨
    "xa"â€¿"src/builtins/arithm.c"â€¿"monarith",
    "xa"â€¿"src/core/stuff.c"â€¿"equal",        "xa"â€¿"src/utils/mut.c"â€¿"copy",       "xa"â€¿"src/utils/bits.c"â€¿"bits"
    "xa"â€¿"src/builtins/arithd.c"â€¿"dyarith", "xa"â€¿"src/builtins/cmp.c"â€¿"cmp",     "xa"â€¿"src/builtins/squeeze.c"â€¿"squeeze"
    "x."â€¿"src/builtins/select.c"â€¿"select",  "x."â€¿"src/builtins/fold.c"â€¿"fold",   "x."â€¿"src/builtins/scan.c"â€¿"scan"
    "x."â€¿"src/builtins/scan.c"â€¿"neq",       "x."â€¿"src/builtins/slash.c"â€¿"slash", "x."â€¿"src/builtins/slash.c"â€¿"constrep"
    "xa"â€¿"src/builtins/transpose.c"â€¿"transpose"
  âŸ©
  objs â† âŸ¨âŸ©
  
  
  
  replxxCache â† {
    Â¬po.replxx? @;
    replxxCache â† GetCache âŸ¨"replxx", "REPLXX object file location", po.REPLXXc@âŸ©
    
    replxxSrc â† (po.replxxDirâ€¢file.At"src")âŠ¸â€¢file.AtÂ¨âŸ¨"ConvertUTF.cpp", "wcwidth.cpp", "conversion.cxx", "escape.cxx", "history.cxx", "prompt.cxx", "replxx.cxx", "replxx_impl.cxx", "terminal.cxx", "util.cxx", "windows.cxx"âŸ©
    objsâˆ¾â†© (Shorten replxxSrc) {MakeCCInv âŸ¨po.REPLXXc, âŠ¢, replxxCache, ğ•¨, ğ•©, âŸ¨âŸ©âŸ©}Â¨ replxxSrc
    
    replxxCache
  }
  
  singeliObjs â† @
  singeliCache â† {
    Â¬po.singeli? @;
    singeliCache â† GetCache âŸ¨"singeli", "Singeli generated code location", âŸ¨po.native, po.arch, po.singeliFlags, po.singeliDirâŸ©âŸ©
    
    # genArithTables
    ga â† "src/singeli/src/genArithTables.bqn"
    gaDefs â† singeliCache.File "arDefs.singeli"
    gaTables â† singeliCache.File "arTables.c"
    gaRule â† AddRule âŸ¨
      singeliCache, "genArithTables",
      gaDefs, # am cheating and only using arDefs.singeli as destination; Â¯\_(ãƒ„)_/Â¯
      {ğ•Š: âŸ¨"runbqn", rootdir, AtRoot ga, AtRootÂ¨ gaDefsâ€¿gaTables, âŸ¨gaâŸ©âŸ©},
      â€¢file.Name ga, âŸ¨âŸ©
    âŸ©
    
    singeliArgs â† po.singeliFlagsâˆ¾âŸ¨"-l", "gen="âˆ¾AtRoot singeliCache.folderâŸ©âˆ¾{
      po.native? âŸ¨âŸ©;
      "-a" â‹ˆ {"x86-64":"X86_64"; "aarch64":"AARCH64"} po.arch
    }
    singeliObjs â†© {MakeSingeliInv âŸ¨singeliArgs, {ğ•Š:UpdateSubmodule po.singeliDir}, singeliCache, ğ•©, "src/singeli/src/"â€¢file.At ğ•©âˆ¾".singeli", (ğ•©â‰¡"dyarith")/âŸ¨gaRuleâŸ©âŸ©}Â¨ 1âŠ‘Â¨singeliMap
    
    singeliCache
  }
  
  cbqnCache â† {
    cbqnCache â† GetCache âŸ¨"cbqn", "CBQN object file location", âŸ¨po.CBQNc@, {po.singeli? singeliCache.folderHash; @}âŸ©âŸ©
    ruleDeps â† {
      Â¬po.singeli? âŸ¨âŸ©Â¨ cbqnSrc;
      ((â‰ cbqnSrc) âˆ¾Ëœ cbqnSrcâŠâŠ‘Â¨singeliMap) âŠ” singeliObjs
    }
    
    singeliArgs â† {po.singeli? âŸ¨"-DSINGELI_DIR="âˆ¾â€¢file.Name singeliCache.folderâŸ©; âŸ¨âŸ©}
    objsâˆ¾â†© {aâ€¿bâ€¿c: MakeCCInv âŸ¨po.CBQNcâˆ¾po.ccColorâˆ¾singeliArgsË™, {ğ•Š:UpdateSubmodule po.bytecodeDir â‹„ UpdateSubmodule po.replxxDir}, cbqnCache, a, b, câŸ©}Â¨ <Ë˜â‰[Shorten cbqnSrc, cbqnSrc, ruleDeps] # updates replxx because needs replxx.h
    
    cbqnCache
  }
  
  linkerDeps â† @âŠ¸â‰¢Â¨âŠ¸/ âŸ¨cbqnCache, replxxCache, singeliCacheâŸ©
  linkerCache â† GetCache âŸ¨"linker", "linker cached result location", âŸ¨po.Linker@, {ğ•©.folderHash}Â¨ linkerDepsâŸ©âŸ©
  {
    po.versionNameâ‰¡@? @;
    srcFile â† linkerCache.File "versionInfo.c"
    src â† "char* cbqn_versionString = """âˆ¾(âˆ¾âˆ¾âŸœ"\n"Â¨ Ã—âˆ˜â‰ Â¨âŠ¸/ âŸ¨
      "CBQN "âˆ¾{po.versionNameâ‰¡""? "on commit "âˆ¾(GitCmd âŸ¨"rev-parse", "HEAD"âŸ©)âˆ¾{""â‰¡GitCmd âŸ¨"status", "--porcelain", "src"âŸ©? ""; "-dirty"}; po.versionName}
      {"built with "âŠ¸âˆ¾âŸ(Ã—â‰ ) Â¯2â†“âˆ¾âˆ¾âŸœ", "Â¨ ğ•©} po.ffiâ€¿po.singeliâ€¿po.replxxâ€¿(Â¬po.o3) / âŸ¨"FFI", "singeli "âˆ¾{po.native? "native"; po.arch}, "replxx", "optimizations disabled"âŸ©
      # "build invocation: "âŠ¸âˆ¾âŸ(Ã—â‰ ) Â¯1â†“âˆ¾âˆ¾âŸœ' 'Â¨ â€¢args
    âŸ©)âˆ¾""";"âˆ¾@+10
    {
      â€¢file.Exists AtRoot srcFile? srcâ‰¡â€¢FChars AtRoot srcFile? @; # don't update
      (AtRoot srcFile) â€¢FChars src
    }
    objsâˆ¾â†© â‹ˆ MakeCCInv âŸ¨po.CBQNc, âŠ¢, linkerCache, "versionInfo", srcFile, âŸ¨âŸ©âŸ©
  }
  
  res â† MakeLinkerInv âŸ¨po.Linker, linkerCache, {po.emcc? "BQN.js"; "windows"â‰¡po.os? "res.exe"; "res"}, objsâŸ©
  
  res.dst â‹ˆ linkerCache
}

outPath â† â€¢wdpath â€¢file.At po.output
{
  po.clangd? clangd.Finish@;
  # else, regular build
  success â† Run cachedBin
  { ğ•Š:
    po.emcc?
      SH âŸ¨"cp", AtRoot cachedBin,                   outPath â€¢file.At â€¢file.Name cachedBinâŸ©
      SH âŸ¨"cp", AtRoot linkerCache.File "BQN.wasm", outPath â€¢file.At "BQN.wasm"âŸ©
    ;
      SH âŸ¨"cp", "-f", AtRoot cachedBin, outPathâŸ©
  }âŸâŠ¢ success
  OnExit@
  â€¢Exit Â¬success
}
