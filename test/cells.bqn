# build/build replxx singeli native g debug f=-DEACH_FILLS f=-DTEST_CELL_FILLS && build/build replxx singeli native g debug heapverify f=-DTEST_CELL_FILLS OUTPUT=BQNh && ./BQN test/cells.bqn path/to/mlochbaum/BQN/bqn.js ./BQNh
# (replace bqn.js path with "reuse" to use the previous result (requires the test set to not have changed))
{ğ•Š: â€¢Out "Usage: ./nonHeapverifyCBQN test/cells.bqn path/to/bqn.js heapverifyCBQN" â‹„ â€¢Exit 0}âŸâŠ¢ 2>â‰ â€¢args
a0 â† âŠ‘â€¢args
bqnjsâ€¿hCBQN â† â€¢wdpathâŠ¸â€¢file.AtÂ¨ â€¢args
bqnjsFile â† â€¢file.At "generated/cells_bqnjsOut.bqn"
hCBQNFile â† â€¢file.At "generated/cells_hCBQNOut.bqn"
validFile â† â€¢file.At "generated/cells_valid.bqn"

cbqni â† {âŠ‘"internal"<âŠ¸âˆŠâ€¢listsys? â€¢BQN"â€¢internal"; @}
bqntype â† {cbqniâ‰¡@? 2; "harr"â‰¡cbqni.Type âŠ¢â‰0 ""} # 0: full CBQN; 1: heapverify CBQN; 2: bqn.js

SHRun â† {
  fâ†â€¢BQN"â€¢SH"
  câ€¿oâ€¿e â† F ğ•©
  gâ†â€¢BQN"â€¢term.OutRawâ€¿â€¢term.ErrRaw {ğ•â€¢ToUTF8ğ•©}Â¨ âŠ¢" â‹„ G oâ€¿e
  câ‰¢0? â€¢Exit c; @
}

GetTests â† { ğ•Š:
  
  tests â† âŸ¨âŸ©
  AddTests â† {testsâˆ¾â†© ğ•© â‹„ @}
  
  Prod â† {â¥Š (<âŸ¨âŸ©) <âŠ¸âˆ¾âŒœÂ´ ğ•©}
  FOk â† { wâ€¿Fâ€¿gâ€¿x: # filter out tests that'd immediately error due to bad shapes, or would 
      g â†© (@â‰¡g)âŠ‘gâ€¿Â¯1
      r â† =Â¨wâ€¿x
      s â† â‰¢Â¨wâ€¿x
      k â† 0âŒˆr-0âŒˆ(âŠ¢+rÃ—0âŠ¸>) 1â†“âŒ½3â¥ŠâŒ½â¥Šg
      # â€¢Show k
      ok â† â‰¡Â´ (âŒŠÂ´k) â†‘Â¨ s
      # {ğ•Š: ! w 0âˆ˜(Fâ‰g)âŠ1 x}âŸÂ¬ ok
      ok âˆ§ kâ‰¢0â€¿0
  }Â¨âŠ¸/
  
  # generating random numerical arrays:
  # )r Nâ†{âŸ¨âŸ©:"1";â€¢ReprâŠ‘âŸ(1=â‰ )ğ•©} â‹„ Jâ†{(âŠ£âˆ¾ğ•¨âˆ¾âŠ¢)Â´ğ•©} â‹„ â€¢Out 'âŸ¨'âˆ¾'âŸ©'âˆ¾Ëœ','J ("â¥Š"Jâ‰¢â‹ˆâ—‹Nâ¥Š)Â¨ 15â†‘ â· {ğ•Š: ((1+â€¢rand.Range 4)â€¢rand.Range 4)â€¢rand.Range 10}Â¨ â†•100
  # xs â†© âŸ¨0,â†•0âŸ© âˆ¾ 
  
  { ğ•Š: # Fâ‰k x
    fs â† âŸ¨<,âŠ,âŠ‘,â‰,â¥Š,Â«,Â»,â‰,Ã—Ë,Â¨,1Ë™,âˆ,'a'Ë™,'ğ•¨',"ab"â€¿2Ë™,âŸ¨âŸ©,<"ab"â€¿1,2â€¿3,â†•2â€¿3â€¿1âŸ©
    xs â† âŸ¨
      1, <2,
      2â€¿3, 2â€¿3â€¿4â¥Šâ†•24, 1â€¿1â€¿1â€¿1â¥Š4,
      â†•0, 0â€¿2â¥Š"", 4â€¿0â¥Š0, 0â€¿2â€¿3â€¿4â€¿5â¥Š0,
      1â€¿1â€¿2â€¿1â¥Š2â€¿'a', 2â€¿2â¥Š"abcd", â†•2â€¿3,
    âŸ©
    ks â† âŸ¨@, Â¯âˆ, Â¯1, 0â€¿âˆâ€¿âˆ, 10â€¿1, âŸ¨2âŸ©, 3, 4, 5, âˆâŸ©
    AddTests Prod âŸ¨fs, ks, xsâŸ©
  }âŸâŠ¢ 1

  { ğ•Š: # w â‹ˆâ‰k x
    xs â† âŸ¨0, 2â€¿2â¥Š"a"â€¿1âŸ©âˆ¾ {ğ•©â¥Šâ†•Ã—Â´â¥Šğ•©}Â¨ âŸ¨1, 2â€¿3, 2â€¿0, 2â€¿3â€¿4, 2â€¿2â€¿3â€¿4, 3â€¿4âŸ©
    ks â† âŸ¨Â¯âˆ, Â¯1, 0, 1, 2, 3, 4, âˆâ€¿0â€¿1, Â¯âˆâ€¿2â€¿1, âˆ, 0â€¿âˆ, âˆâ€¿0, 1â€¿âˆ, âˆâ€¿1, 2â€¿âˆ, âˆâ€¿2âŸ©
    AddTests Prod âŸ¨xs, â‹ˆ, ks, xsâŸ©
  }âŸâŠ¢ 1
  
  { ğ•Š: # w âŠâ‰k x / w âŠ‘â‰k x
    ws â† âŸ¨0, 1, 2, 3, Â¯1, Â¯2, <1âŸ©
    xs â† âŸ¨2â€¿2â¥Š"a"â€¿1â€¿"b"â€¿"cd", 3â€¿3â€¿3â¥Š'a'+â†•27, 3â€¿6âŸ©âˆ¾ {ğ•©â¥Šâ†•Ã—Â´â¥Šğ•©}Â¨ âŸ¨2â€¿3, 2â€¿0, 2â€¿3â€¿4, 2â€¿2â€¿3â€¿4, 3â€¿4âŸ©
    ks â† âŸ¨0, 1, 2, 3, 4, 0â€¿1, 0â€¿2âŸ©
    AddTests FOk Prod âŸ¨ws, âŠâ€¿âŠ‘, ks, xsâŸ©
    AddTests FOk Prod âŸ¨0â€¿100â€¿Â¯100â€¿âˆ, âŠâ€¿âŠ‘, 0â€¿1â€¿2, xsâˆ¾âŸ¨0,<4âŸ©âŸ©
  }âŸâŠ¢ 1
  
  { ğ•Š: # w â‰¡â‰k x
    xs â† âŸ¨0, 2â€¿3â¥Š@+â†•6âŸ©âˆ¾ {ğ•©â¥Šâ†•Ã—Â´â¥Šğ•©}Â¨ âŸ¨1, 2â€¿3, 0â€¿3, 2â€¿0â€¿3, 4â€¿2â€¿3, 2â€¿4â€¿2â€¿3, 3â€¿1âŸ©
    ks â† âŸ¨Â¯âˆ, Â¯1, 0, 1, 2, 3, 4, 0â€¿1, 2â€¿1âŸ©
    AddTests FOk Prod âŸ¨xs, â‰¡, ks, xsâŸ©
    xs2 â† âŸ¨2â€¿3â¥Š175, [Â¯81â€¿Â¯81â€¿Â¯81, 0â€¿0â€¿0]âŸ©âˆ¾{ğ•©-Ëœğ•©+2â€¿3â¥Š'Â¯'}Â¨ 0â€¿100â€¿100000
    AddTests FOk Prod âŸ¨xs2, â‰¡, ks, xs2âŸ©
  }âŸâŠ¢ 1
  
  { ğ•Š: # w â‰â‰k x
    ws â† âŸ¨0, 1, 2, 3, 4, Â¯1, 1â€¿0âŸ©
    xs â† âŸ¨2â€¿2â€¿2â¥Š"a"â€¿1â€¿"b", 3â€¿3â€¿3â¥Š'a'+â†•27, 3â€¿6âŸ©âˆ¾ {ğ•©â¥Šâ†•Ã—Â´â¥Šğ•©}Â¨ âŸ¨2â€¿3, 2â€¿0, 2â€¿3â€¿4, 2â€¿2â€¿3â€¿4, 3â€¿4, 3â€¿2â€¿1â€¿2â€¿2âŸ©
    ks â† âŸ¨0, 1, 2, 3, 4, 5, 0â€¿1, 0â€¿2âŸ©
    AddTests FOk Prod âŸ¨ws, â‰, ks, xsâŸ©
  }âŸâŠ¢ 1
  
  { ğ•Š: # w Â»â‰k x / w Â«â‰k x
    ws â† âŸ¨0, 1, 'a', "ab", <"h"â€¿2âŸ©
    xs â† âŸ¨2â€¿2â€¿2â¥Š"a"â€¿1â€¿"b", 3â€¿3â€¿3â¥Š'a'+â†•27, 3â€¿6âŸ©âˆ¾ {ğ•©â¥Šâ†•Ã—Â´â¥Šğ•©}Â¨ âŸ¨2â€¿3, 2â€¿0, 2â€¿3â€¿4, 2â€¿2â€¿3â€¿4, 3â€¿4, 3â€¿2â€¿1â€¿2â€¿2âŸ©
    ks â† âŸ¨0, 1, 2, 3, 4, @, 0â€¿1, 0â€¿2âŸ©
    AddTests FOk Prod âŸ¨ws, Â«â€¿Â», ks, xsâŸ©
  }âŸâŠ¢ 1
  
  { ğ•Š: # w â†‘â‰k x / w â†“â‰k x
    ws â† âŸ¨0,1,2,Â¯1,Â¯2,10,1â€¿1âŸ©
    xs â† âŸ¨2â€¿2â€¿2â¥Š"a"â€¿1â€¿"b", 3â€¿3â€¿3â¥Š'a'+â†•27, 3â€¿6âŸ©âˆ¾ {ğ•©â¥Šâ†•Ã—Â´â¥Šğ•©}Â¨ âŸ¨2â€¿3, 0â€¿2, 2â€¿0, 2â€¿3â€¿4, 2â€¿2â€¿3â€¿4, 3â€¿4, 3â€¿2â€¿1â€¿2â€¿2âŸ©
    ks â† âŸ¨0, 1, 2, 3, 4, @, 0â€¿1, 0â€¿2, 1â€¿Â¯1âŸ©
    AddTests FOk Prod âŸ¨ws, â†‘â€¿â†“, ks, xsâŸ©
  }âŸâŠ¢ 1
  
  { ğ•Š: # w -â‰k x
    xs â† {ğ•©â¥Šâ†•Ã—Â´â¥Šğ•©}Â¨ âŸ¨2â€¿3â€¿4, 2â€¿3, 3â€¿4, 2, 3, 4, 2â€¿2â€¿3â€¿4, 3â€¿2â€¿1â€¿2â€¿2âŸ©
    ks â† âŸ¨0, 1, 2, 3, 4, Â¯1, Â¯2, 0â€¿1, 0â€¿2, 1â€¿0, 2â€¿0, 2â€¿1, 1â€¿2âŸ©
    AddTests FOk Prod âŸ¨xs, -, ks, xsâŸ©
    AddTests Prod âŸ¨xs, -, âˆ, xsâŸ© # test regular leading axis behavior
  }âŸâŠ¢ 1
  
  tests
}

getFill â† {bqntypeâ‰¢2? cbqniâ€¢ns.Has"hasfill"? {cbqni.HasFill ğ•©? âŠ‘1â†‘0â¥Šğ•©; '!'}; {1 âŠ‘âˆ˜â†‘âŠ'!' 0â¥Šğ•©}}
Info â† {âŸ¨ğ•©, GetFill ğ•©âŸ©}
RunTests â† {
    fâ€¿kâ€¿x:   (Info F{kâ‰¡@? ğ”½Ë˜; ğ”½â‰k})âŠ"err" x;
  wâ€¿fâ€¿kâ€¿x: w (Info F{kâ‰¡@? ğ”½Ë˜; ğ”½â‰k})âŠ"err" x
}Â¨


{
  "0"â‰¡a0? # bqn.js
     â€¢OutâŸ(bqntypeâ‰ 2) "Warning: doesn't seem like the first argument is bqn.js!"
    res â† RunTests GetTests@
    bqnjsFile â€¢FChars â€¢Repr res
  ;
  "1"â‰¡a0? # heapverify
    â€¢OutâŸ(bqntypeâ‰ 1) "Warning: doesn't seem like the second argument is CBQN with heapverify!"
    tests â† GetTests@
    valid â† '0'-Ëœâ€¢FChars validFile
    ok â† validâ‰ 2
    HTests â† { ğ•Š:
      okTests â† ok/tests
      hasFill â† 0=ok/valid
      cbqni.Temp 2 â‹„ f1 â† RunTests okTests /Ëœ hasFill
      cbqni.Temp 1 â‹„ f0 â† RunTests okTests /Ëœ Â¬hasFill
      cbqni.Temp 0
      (â‹â‹hasFill) âŠ f0âˆ¾f1
    }
    hCBQNFile â€¢FChars â€¢Repr HTestsâŒ¾(okâŠ¸/) "err"Â¨ tests
  ;
  # base
    â€¢OutâŸ(bqntypeâ‰ 0) "Warning: doesn't seem like the running binary is CBQN without heapverify!"
    
    tests â† GetTests@
    â€¢Out âˆ¾âŸ¨"Running ", â€¢Repr â‰ tests, " tests on base CBQN.."âŸ©
    cfeâ€¿fo â† <Ë˜â‰>{cbqni.Temp@ â‹„ (cbqni.Temp@) â‹ˆ âŠ‘RunTests â‹ˆğ•©}Â¨ tests
    validFile â€¢FChars '0'+ 2âŒŠ cfe + 2Ã—"err"âŠ¸â‰¡Â¨ fo # 2: errored; 1: invalid fill; 0: valid fill
    
    { ğ•Š:
      â€¢Out "Calling bqn.js.."
      â€¢file.RemoveâŸâ€¢file.Exists bqnjsFile
      SHRun âŸ¨bqnjs,  â€¢file.At "cells.bqn", "0", ""âŸ©
      {â€¢file.Exists bqnjsFile?@; â€¢Out "bqn.js didn't produce the result file!" â‹„ â€¢Exit 1}
    }âŸâŠ¢ "reuse"â‰¢a0
    
    â€¢file.RemoveâŸâ€¢file.Exists hCBQNFile
    â€¢Out "Calling heapverify build.."
    SHRun âŸ¨hCBQN, â€¢file.At "cells.bqn", "1", ""âŸ©
    
    â€¢Out "Comparing.."
    bo â† â€¢Import bqnjsFile
    ho â† â€¢Import hCBQNFile
    
    hCount â† +Â´ "err"âŠ¸â‰¢Â¨ bo
    badHâ†0 â‹„ hBadFillâ†0 â‹„ hSupersetâ†0
    badBâ†0 â‹„ bBadFillâ†0 â‹„ bSupersetâ†0
    
    hBadEmptyâ†0
    hBadButBaseâ†0
    
    FRepr â† {0â‰¢â‰ â¥Šğ•©? â€¢Repr ğ•©; '!'â‰¢fâ†GetFill ğ•©? âˆ¾âŸ¨â€¢Reprâ‰¢ğ•©, "â¥Š", "<"âŠ¸âˆ¾âŸ(0â‰ â‰¡f) â€¢Repr fâŸ©; â€¢Repr ğ•©}
    FTest â† { testâ€¿expâ€¿got:
      ! expâ‰¢got
      âˆ¾âŸ¨
        {Fâ€¿kâ€¿xâ†Â¯3â†‘ğ•© â‹„ âˆ¾âŸ¨{3â‰¡â‰ ğ•©?""; "("âˆ¾") "âˆ¾ËœFReprâŠ‘ğ•©}ğ•© , â€¢Repr f, {kâ‰¡@?"Ë˜";"â‰"âˆ¾â€¢Repr k}, " ", FRepr xâŸ©} test
        ": "
        {
          expâ‰¡"err"? "expected error, but got "âˆ¾â€¢Repr âŠ‘got;
          gotâ‰¡"err"? "expected result, but got error";
          {ğ•¨âˆ¾"; "âˆ¾ğ•©}Â´ @âŠ¸â‰¢Â¨âŠ¸/ "result"â€¿"result fill" {mğ•Šeâ€¿g: {eâ‰¡g? @; âˆ¾âŸ¨"expected ",m," to be ",FRepr e,", got ",FRepr gâŸ©}}Â¨ <Ë˜â‰>âŸ¨exp,gotâŸ©
        }
      âŸ©
    }
    
    { ğ•Š tâ€¿fâ€¿bâ€¿h:
      {
        bâ‰¡f?@;
        bâ‰¢â—‹âŠ‘f? badB+â†©1 â‹„ â€¢Out âˆ¾âŸ¨"base: incrorrect result: ",FTest tâ€¿bâ€¿fâŸ©;
        '!'â‰¡1âŠ‘b? bSuperset+â†©1;
        bBadFill+â†©1 â‹„ â€¢Out âˆ¾âŸ¨"base: bad fill: ",FTest tâ€¿bâ€¿fâŸ©
      }
      {
        bâ‰¡h?@; {âˆ¨Â´0=â‰ âˆ˜â¥ŠÂ¨ (Â¯3â†“t)âˆ¾Â¯1â†‘t? hBadEmpty+â†©1;@}
        fâ‰¡h? hBadButBase+â†©1;
        bâ‰¢â—‹âŠ‘h? badH+â†©1 â‹„ â€¢Out âˆ¾âŸ¨"heapverify: incrorrect result: ",FTest tâ€¿bâ€¿hâŸ©;
        '!'â‰¡1âŠ‘b? hSuperset+â†©1;
        hBadFill+â†© 1 â‹„ â€¢Out âˆ¾âŸ¨"heapverify: bad fill: ",FTest tâ€¿bâ€¿hâŸ©
        
        # âˆ¨Â´0=â‰ âˆ˜â¥ŠÂ¨ (Â¯3â†“t)âˆ¾Â¯1â†‘t? hBadEmpty+â†©1;
        # badH+â†©1 â‹„ â€¢Out âˆ¾âŸ¨"heapverify: incrorrect result: ",FTest tâ€¿bâ€¿hâŸ©
      }
    }Â¨ <Ë˜â‰>âŸ¨tests, fo, bo, hoâŸ©
    
    â€¢Out âˆ¾âŸ¨
      "Base: ",
      â€¢Repr â‰ tests, " tests: "
      â€¢Repr badB, " wrong results, "
      â€¢Repr bBadFill, " wrong fills, "
      â€¢Repr bSuperset, " superset fills"
    âŸ©
    hBadTot â† hBadFill
    â€¢Out âˆ¾âŸ¨
      "Heapverify: "
      â€¢Repr hCount, " tests: "
      â€¢Repr hBadButBase, " wrong results equal to base, "
      â€¢Repr badH, " wrong results, "
      â€¢Repr hBadFill, " wrong fills, "
      â€¢Repr hSuperset, " superset fills; "
      â€¢Repr hBadEmpty, " wrong results had empty input(s)"
    âŸ©
    â€¢ExitâŸ(âˆ¨Â´0â‰ badHâ€¿badB) 1
    â€¢Out "Passed!"
}
