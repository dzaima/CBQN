%DEF var Vâ†â€¢internal.Variation â‹„ LVâ†â€¢internal.ListVariations â‹„ CLRâ†â€¢internal.ClearRefs
%DEF tvar %USE var â‹„ _tvar â† {F _ğ•£ x: (CLR@) âŠ¢ {F ğ•© V x}Â¨ LV ğ•©; w F _ğ•£ x: (CLR@) âŠ¢ (LV ğ•¨) {(ğ•¨ V w) F ğ•© V x}âŒœ LV ğ•©}
%DEF defs size_t â† "u64"


# bad â€¢FFI invocation
# generally weird
@ â€¢FFIâŠ9 ""â€¿"bqn_this symbol doesn't exist" %% 9
!"FFI: Type must be a string" % @â€¢FFI "hello"
!"FFI: Error parsing type: Unexpected character '?'" % @â€¢FFI""â€¿"bqn_init"â€¿"?"
!"FFI: Bad array type" % @â€¢FFI""â€¿"bqn_init"â€¿"["
!"FFI: Bad array type" % @â€¢FFI""â€¿"bqn_init"â€¿"[0"
!"FFI: Error parsing type: Unexpected end of input" % @â€¢FFI""â€¿"bqn_init"â€¿"[1]"
!"FFI: Error parsing type: Unexpected end of input" % @â€¢FFI""â€¿"bqn_init"â€¿"{"
!"FFI: Bad integer width" % @â€¢FFI""â€¿"bqn_init"â€¿"i"
!"FFI: Bad float width" % @â€¢FFI""â€¿"bqn_init"â€¿"f80"
!"FFI: Bad float width" % @â€¢FFI""â€¿"bqn_init"â€¿"f128"
!"FFI: Bad float width" % @â€¢FFI""â€¿"bqn_init"â€¿"f16"
!"FFI: Bad float width" % @â€¢FFI""â€¿"bqn_init"â€¿"f1"
!"FFI: Bad integer width" % @â€¢FFI""â€¿"bqn_init"â€¿"u1"
!"FFI: Bad integer width" % @â€¢FFI""â€¿"bqn_init"â€¿"i0"
!"FFI: Bad integer width" % @â€¢FFI""â€¿"bqn_init"â€¿"i10"
!"FFI: Bad integer width" % @â€¢FFI""â€¿"bqn_init"â€¿"u128"
!"FFI: number literal too large" % @â€¢FFI""â€¿"bqn_init"â€¿"u99999999999999"
!"FFI: Too many arguments" % @â€¢FFI""â€¿"bqn_init"âˆ¾70000â¥Š<"i32"

# >/ğ•¨/ğ•©
!"FFI: At least one argument should be in ğ•©" % @â€¢FFI""â€¿"bqn_init"â€¿"ğ•¨i32"â€¿"ğ•¨i32"
!"FFI: Multiple occurrences of '>' within one argument" % @â€¢FFI""â€¿"bqn_init"â€¿">>i32"
!"FFI: Multiple occurrences of argument side specified" % @â€¢FFI""â€¿"bqn_init"â€¿"ğ•¨ğ•¨i32"
!"FFI: Multiple occurrences of argument side specified" % @â€¢FFI""â€¿"bqn_init"â€¿"ğ•©ğ•©i32"
!"FFI: Multiple occurrences of argument side specified" % @â€¢FFI""â€¿"bqn_init"â€¿"ğ•¨ğ•©i32"
!"FFI: Multiple arguments on ğ•© specified, some with '>'" % @â€¢FFI""â€¿"bqn_init"â€¿">i32"â€¿">i32"
!"FFI: Multiple arguments on ğ•¨ specified, some with '>'" % @â€¢FFI""â€¿"bqn_init"â€¿">ğ•¨i32"â€¿">ğ•¨i32"
!"FFI: Multiple arguments on ğ•© specified, some with '>'" % @â€¢FFI""â€¿"bqn_init"â€¿">i32"â€¿"i32"
!"FFI: Multiple arguments on ğ•¨ specified, some with '>'" % @â€¢FFI""â€¿"bqn_init"â€¿">ğ•¨i32"â€¿"ğ•¨i32"

# arrays
!"FFI: 0-item arrays not supported" % @â€¢FFI""â€¿"bqn_init"â€¿"[0]i32"
!"FFI: number literal too large" % @â€¢FFI""â€¿"bqn_init"â€¿"[999999999999]i32"
!"FFI: Top-level array too large; limit is 65535 elements" % @â€¢FFI""â€¿"bqn_init"â€¿"[65536]i32"
!"FFI: Top-level array too large; limit is 65535 elements" % @â€¢FFI""â€¿"bqn_init"â€¿"[4000000000]i32"
!"FFI: Array too large; limit is 65534 bytes" % @â€¢FFI""â€¿"bqn_init"â€¿"*[20000]i32"
!"FFI: Cannot return array" % @â€¢FFI"[4]i32"â€¿"bqn_init"

# structs
!"FFI: Improper struct separator or end" % @â€¢FFI""â€¿"bqn_init"â€¿"{*i32*i32}"
!"FFI: Improper struct separator or end" % @â€¢FFI""â€¿"bqn_init"â€¿"{*i32"
!"FFI: Error parsing type: Unexpected end of input" % @â€¢FFI""â€¿"bqn_init"â€¿"{*i32,"
!"FFI: Structs currently cannot contain mutable references" % @â€¢FFI""â€¿"bqn_init"â€¿"{&i32}"

# :
!"FFI: Garbage at end of type" % @â€¢FFI""â€¿"bqn_init"â€¿"i32:"
!"Unsupported width in :i0" % @â€¢FFI""â€¿"bqn_init"â€¿"i32:i"
!"Unsupported width in :i9" % @â€¢FFI""â€¿"bqn_init"â€¿"i32:i9"
!"Unsupported width in :u16" % @â€¢FFI""â€¿"bqn_init"â€¿"i32:u16"
!"Unsupported width in :i64" % @â€¢FFI"i32:i64"â€¿"bqn_init"
!"Unsupported width in :f32" % @â€¢FFI""â€¿"bqn_init"â€¿"i32:f32"
!"FFI: number literal too large" % @â€¢FFI""â€¿"bqn_init"â€¿"i32:u9999999999999999"
!"FFI: Representation wider than the value for ""i32:f64""" % @â€¢FFI""â€¿"bqn_init"â€¿"i32:f64"
!"FFI: Garbage at end of type" % @â€¢FFI""â€¿"bqn_init"â€¿"i32 hello world"

# return value
!"FFI: Function specification must have at least two items" % @â€¢FFI âŸ¨"&"âŸ©
!"FFI: Return value is specified as ""&"", but there are 0 mutated values" % @â€¢FFI"&"â€¿"bqn_init"â€¿">*i32"
!"FFI: Return value is specified as ""&"", but there are 2 mutated values" % @â€¢FFI"&"â€¿"bqn_init"â€¿"&i32"â€¿"&i32"
!"FFI: Cannot return array" % @â€¢FFI"[4]i32"â€¿"bqn_init"
!"FFI: Unimplemented result type" % @â€¢FFI"*i32"â€¿"bqn_init"
!"FFI: Unimplemented result type" % @â€¢FFI"&i32"â€¿"bqn_init"


# correct elements
%USE defs â‹„ fâ†@â€¢FFI"&"â€¿"memcpy"â€¿"&u8"â€¿"*i8"â€¿size_t â‹„ Gâ†{FâŸ¨ğ•©,â†•0,0âŸ©} â‹„ %USE tvar â‹„ !âˆ˜â‰¡Â¨âŸœâŠ G _tvar 100â¥Š1â€¿0
%USE defs â‹„ fâ†@â€¢FFI"&"â€¿"memcpy"â€¿"&u8"â€¿"*i8"â€¿size_t â‹„ Gâ†{FâŸ¨ğ•©,â†•0,0âŸ©} â‹„ G â†•200 %% â†•200
%USE defs â‹„ fâ†@â€¢FFI"&"â€¿"memcpy"â€¿"&u16"â€¿"*i8"â€¿size_t â‹„ Gâ†{FâŸ¨ğ•©,â†•0,0âŸ©} â‹„ G â‹ˆ65535 %% â‹ˆ65535
%USE defs â‹„ fâ†@â€¢FFI"&"â€¿"memcpy"â€¿"&i16"â€¿"*i8"â€¿size_t â‹„ Gâ†{FâŸ¨ğ•©,â†•0,0âŸ©} â‹„ G Â¯32768â€¿32767 %% Â¯32768â€¿32767
%USE defs â‹„ fâ†@â€¢FFI"&"â€¿"memcpy"â€¿"&{i16}"â€¿"*i8"â€¿size_t â‹„ Gâ†{FâŸ¨ğ•©,â†•0,0âŸ©} â‹„ G â‹ˆÂ¨Â¯32768â€¿32767 %% â‹ˆÂ¨Â¯32768â€¿32767



# bad array elements
!"FFI: Structs currently cannot contain mutable references" % %USE defs â‹„ fâ†@â€¢FFI"&"â€¿"memcpy"â€¿"&{&i16}"â€¿"*i8"â€¿size_t â‹„ Gâ†{FâŸ¨ğ•©,â†•0,0âŸ©} â‹„ G â‹ˆâˆ˜â‹ˆÂ¨Â¯32768â€¿32767

!"FFI: Array provided for &u8 contained 299" % fâ†@â€¢FFI"&"â€¿"bqn_init"â€¿">&u8" â‹„ F â†•300
!"FFI: Array provided for &u8 contained Â¯99" % fâ†@â€¢FFI"&"â€¿"bqn_init"â€¿">&u8" â‹„ F -â†•100
!"FFI: Array provided for &u16 contained 65536" % fâ†@â€¢FFI"&"â€¿"bqn_init"â€¿">&u16" â‹„ F â‹ˆ65536
!"FFI: Array provided for &u32 contained 4294967296" % fâ†@â€¢FFI"&"â€¿"bqn_init"â€¿">&u32" â‹„ F â‹ˆ2â‹†32
!"FFI: Array provided for &u16 contained Â¯1" % fâ†@â€¢FFI"&"â€¿"bqn_init"â€¿">&u16" â‹„ F â‹ˆÂ¯1
!"FFI: Array provided for &u32 contained Â¯1" % fâ†@â€¢FFI"&"â€¿"bqn_init"â€¿">&u32" â‹„ F â‹ˆÂ¯1

!"FFI: Array provided for &i16 contained 32768" % fâ†@â€¢FFI"&"â€¿"bqn_init"â€¿">&i16" â‹„ F Â¯32768â€¿32768
!"FFI: Array provided for &i16 contained Â¯32769" % fâ†@â€¢FFI"&"â€¿"bqn_init"â€¿">&i16" â‹„ F Â¯32768â€¿Â¯32769

!"FFI: Array provided for &u8 contained an array" % fâ†@â€¢FFI"&"â€¿"bqn_init"â€¿">&u8" â‹„ F âŸ¨â†•300âŸ©
!"FFI: Array provided for &i16 contained a character" % fâ†@â€¢FFI"&"â€¿"bqn_init"â€¿">&i16" â‹„ F "hi"
!"FFI: Array provided for &f64 contained a namespace" % fâ†@â€¢FFI"&"â€¿"bqn_init"â€¿">&f64" â‹„ F 1â€¿2â€¿{â‡}

# bad scalars
!"FFI: u8 argument not exact" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">u8" â‹„ F 256
!"FFI: u16 argument not exact" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">u16" â‹„ F Â¯1
!"FFI: u32 argument not exact" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">u32" â‹„ F Â¯1
!"FFI: u64 argument not exact" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">u64" â‹„ F Â¯1
!"FFI: u32 argument not exact" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">u32" â‹„ F 2â‹†32
!"FFI: u32 argument not exact" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">u32" â‹„ F 1e20
!"FFI: u64 argument value â‰¥ 2â‹†53" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">u64" â‹„ F 2â‹†53
!"FFI: i64 argument absolute value â‰¥ 2â‹†53" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">i64" â‹„ F 2â‹†53
!"FFI: i64 argument absolute value â‰¥ 2â‹†53" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">i64" â‹„ F -2â‹†53



# bad overall argument separation
!"FFI: Expected array ğ•©" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿"i32"â€¿"i32" â‹„ F @
!"FFI: Unnecessary ğ•¨ given" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿"i32"â€¿"i32" â‹„ @ F 1â€¿2
!"FFI: Wrong argument count in ğ•©: expected 2, got 3" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿"i32"â€¿"i32" â‹„ F âŸ¨â†•2, â†•2, â†•2âŸ©
!"FFI: Wrong argument count in ğ•©: expected 2, got 1" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿"i32"â€¿"i32" â‹„ F âŸ¨â†•2âŸ©
!"FFI: Wrong argument count in ğ•¨: expected 2, got 3" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿"i32"â€¿"ğ•¨i32"â€¿"ğ•¨i32" â‹„ âŸ¨â†•2, â†•2, â†•2âŸ© F âŸ¨4âŸ©



# wrong argument internal structure
!"FFI: Expected array corresponding to ""i32:i8""" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">i32:i8" â‹„ F @
!"FFI: Bad array corresponding to ""i32:i8"": expected 4 elements, got 10" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">i32:i8" â‹„ F â†•10

!"FFI: Expected array corresponding to a pointer" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">*i32:i8" â‹„ F @

!"FFI: Expected array corresponding to *{...}" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">*{i32}" â‹„ F @
!"FFI: Expected array corresponding to a struct" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">{i32}" â‹„ F @
!"FFI: Expected array corresponding to a struct" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">*{i32}" â‹„ F âŸ¨@âŸ©
!"FFI: Incorrect list length corresponding to a struct: expected 1, got 0" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">*{i32}" â‹„ F âŸ¨âŸ¨âŸ©âŸ©
!"FFI: Incorrect list length corresponding to a struct: expected 1, got 2" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">*{i32}" â‹„ F âŸ¨1â€¿2âŸ©
!"FFI: Incorrect list length corresponding to an array: expected 2, got 0" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">*[2]i32" â‹„ F âŸ¨âŸ¨âŸ©âŸ©
!"FFI: Incorrect list length corresponding to an array: expected 2, got 3" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">*[2]i32" â‹„ F âŸ¨1â€¿2â€¿3âŸ©



# unimplemented stuff
!"FFI: ""*"" unimplemented" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">*" â‹„ F 1
!"FFI: ""*i64"" argument type not yet implemented" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">&i64" â‹„ F â†•10
!"FFI: ""*i64"" argument type not yet implemented" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">*i64" â‹„ F â†•10
!"FFI: ""*u64"" argument type not yet implemented" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">&u64" â‹„ F â†•10
!"FFI: Pointer element type not implemented" % fâ†@â€¢FFI""â€¿"bqn_init"â€¿">**u64" â‹„ F âŸ¨â†•2âŸ©


