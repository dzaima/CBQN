### WHOLE-FILE-TEST
# tests if squeeze produces the optimal result
helpers â† âŠ‘â€¢args
r â† helpers.GetRand@
âŸ¨EEqual, ClearRefs, Variation, Unshare, Squeeze, TypeâŸ© â† â€¢internal

ntn â† "bit"â€¿"i8"â€¿"i16"â€¿"i32"â€¿"f64"
ntv â† "Ab"â€¿"Ai8"â€¿"Ai16"â€¿"Ai32"â€¿"Af64"
nmin â† 0âˆ¾  -2â‹†Â¯1+8Ã—2â‹†â†•3
nmax â† 1âˆ¾Â¯1+2â‹†Â¯1+8Ã—2â‹†â†•3
int â† 1â€¿1â€¿1â€¿1â€¿0

ctn â† "c8"â€¿"c16"â€¿"c32"
ctv â† "Ac8"â€¿"Ac16"â€¿"Ac32"
cmax â† 1114112âŒŠ2â‹†8Ã—2â‹†â†•3

âŸ¨specF64âŸ© â† âŸ¨râŸ© helpers.Import "utils.bqn"
spec â† specF64âˆ¾{â‡}âˆ¾"aâ‰ğ•¨"âˆ¾(@+1114111-â†•5)âˆ¾<"foo"

RandEl â† r.Rangeâˆ˜3â—¶âŸ¨
  {ğ•Š: r.Rangeâˆ˜â‰ âŠ¸âŠ‘ spec} # some special values
  {ğ•Š: -âŸ(r.Range 2) (Â¯5+r.Range 10) + 2â‹†r.Range 64} # random near-power-of-two number
  {ğ•Š: @+0âŒˆ1114111âŒŠ(Â¯5+r.Range 10) + 2â‹†2+r.Range 20} # random near-power-of-two character
âŸ©

Do â† { ğ•Š:
  val â† RandEl@
  base â† RandEl@
  
  len â† 1+r.Range 2â‹†3+r.Range 7
  pos â† r.Range len
  arr â† "Ah" Variation valâŒ¾(posâŠ¸âŠ‘) lenâ¥Š<base
  
  vals â† âˆ¾âŸœâŸ¨baseâŸ©âŸ(len>1) âŸ¨valâŸ©
  expg â† (âˆ§Â´âŠ‘=âŠ¢)â—¶3â€¿âŠ‘ {
    1=ğ•©? 1;
    2=ğ•©? 2;
    3
  }âˆ˜â€¢typeÂ¨ vals
  
  tOutâ€¿tIn â† {
    expg=1?
      msk â† âˆ§Â´ {((Â¬int) âˆ¨ ğ•©â‰¡âŒŠğ•©) âˆ§ 1âˆ¾Ëœ (â‰¥âŸœnminâˆ§â‰¤âŸœnmax)ğ•©}Â¨ vals
      âŸ¨1â†‘msk/ntn â‹„ "Ah"â€¿"Af"âˆ¾msk/ntvâŸ©;
    expg=2?
      msk â† âˆ§Â´ {cmax>ğ•©-@}Â¨ vals
      âŸ¨1â†‘msk/ctn â‹„ "Ah"â€¿"Af"âˆ¾msk/ctvâŸ©;
    expg=3?
      âŸ¨"h"â€¿"fill" â‹„ "Ah"â€¿"Af"âŸ©
  }
  tIn â†© {'S'âˆ¾1â†“ğ•©}Â¨âŠ¸âˆ¾ âˆ¾âŸœ"Inc"Â¨âŠ¸âˆ¾ tIn
  
  { 
    arrv â† ğ•© Variation arr
    arrv0 â† Unshare arrv
    sq â† Squeeze arrv
    sqt â† Type sq
    sqtâ†©{
         "arr"â‰¡Â¯3â†‘sqt?  Â¯3â†“sqt;
      !"slice"â‰¡Â¯5â†‘sqt â‹„ Â¯5â†“sqt
    }
    Â¬ (arrv0 EEqual arr) âˆ§ (arrv0 EEqual sq) âˆ§ (âŠ‘(<sqt) âˆŠ tOut)?
      â€¢Out "Fail:"
      â€¢Out "Array: "âˆ¾â€¢Repr arr
      â€¢Out "Squeezed: "âˆ¾â€¢Repr sq
      â€¢Out "Testing variation "âˆ¾â€¢Repr ğ•©
      â€¢Out "Got: "âˆ¾(Type sq)âˆ¾" / "âˆ¾sqt
      â€¢Out "Expected one of: "âˆ¾â€¢Repr tOut
      !0
    ;@
  }Â¨ tIn
  ClearRefs@
}

DoÂ¨ â†•100000
