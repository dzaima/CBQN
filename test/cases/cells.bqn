%DEF var Vâ†â€¢internal.Variation â‹„ LVâ†â€¢internal.ListVariations â‹„ CLRâ†â€¢internal.ClearRefs
%DEF tvar %USE var â‹„ _tvar â† {F _ğ•£ x: (CLR@) âŠ¢ {F ğ•© V x}Â¨ LV ğ•©; w F _ğ•£ x: (CLR@) âŠ¢ (LV ğ•¨) {(ğ•¨ V w) F ğ•© V x}âŒœ LV ğ•©}
%DEF eqvar %USE tvar â‹„ _eqvar â† {r â† ğ•¨ ğ”½ _tvar ğ•© â‹„ !âˆ˜â‰¡âŸœ(âŠ‘r)Â¨ r â‹„ âŠ‘r}
%DEF evar %USE tvar â‹„ _evar â† {okâ†{â‡} â‹„ râ†â¥Šğ•¨ okâˆ˜ğ”½âŠ{ğ•Š: â€¢CurrentError@} _tvar ğ•© â‹„ {âŠ‘okâˆŠr? !"TEST FAIL: variation didn't error"; ("TEST FAIL: varying error messages"âŠ¸â‹ˆ ! 1=â‰ )â·r â‹„ !âŠ‘r}}
%DEF eqerr %USE eqvar â‹„ _eqerr â† {okâ†{â‡} â‹„ râ†â¥Šğ•¨ okâˆ˜ğ”½âŠ{ğ•Š: â€¢CurrentError@}âŒœ ğ•© â‹„ {âŠ‘okâˆŠr? !"TEST FAIL: case didn't error"; ("TEST FAIL: varying error messages"âŠ¸â‹ˆ ! 1=â‰ )â·r â‹„ !âŠ‘r}}
%DEF k _k â† {ğ”½â—‹â€¢internal.Keep}
%DEF tcc %USE k â‹„ %USE var â‹„ _tcc â† { ! âˆ§Â´ (<ğ•¨ ğ”½_kË˜âŠ'e' ğ•©) â‰¡Â¨ (ğ•¨ ğ”½Ë˜âŠ'e'VâŸœğ•©)Â¨ "i"LVğ•©}

1â€¿2 1â‰0 1 %% 1â€¿1
1 1â‰0 1â€¿2 %% 1â€¿1
! 20â€¿1200â‰¡â‰¢â¥ŠË˜aâ†20â€¿30â€¿40â¥Šâ†•24 â‹„ ! 20â€¿30â€¿40 â‰¡ â‰¢a
! (2âŠ¸-â‰1 â‰¡ {2-ğ•©}â‰1) 10â€¿10â¥Šâ†•100
! (-âŸœ2â‰1 â‰¡ {ğ•©-2}â‰1) 10â€¿10â¥Šâ†•100
%USE k â‹„ nâ†1 â‹„ â‰ {ğ•Š: (â€¢Repr a) ! (â‰¡â‰n â‰¡ â‰¡_kâ‰n)Â´ aâ†(âŠâŸœ(3â€¿2â€¿2â¥Š'a'+â†•26))Â¨ <Ë˜ 2â€¿2â€¿2â€¿2â€¢rand.Range 3}Â¨ â†•1000
%USE k â‹„ nâ†2 â‹„ â‰ {ğ•Š: (â€¢Repr a) ! (â‰¡â‰n â‰¡ â‰¡_kâ‰n)Â´ aâ†(âŠâŸœ(3â€¿2â€¿2â¥Š'a'+â†•26))Â¨ <Ë˜ 2â€¿2â€¿2â€¿2â€¢rand.Range 3}Â¨ â†•1000
%USE k â‹„ nâ†3 â‹„ â‰ {ğ•Š: (â€¢Repr a) ! (â‰¡â‰n â‰¡ â‰¡_kâ‰n)Â´ aâ†(âŠâŸœ(3â€¿2â€¿2â¥Š'a'+â†•26))Â¨ <Ë˜ 2â€¿2â€¿2â€¿2â€¢rand.Range 3}Â¨ â†•1000
â‰ {ğ•Šk: ! (3âŠ¸â†‘â‰k â‰¡ {3â†‘ğ•©}â‰k) 2â€¿2â€¿2â€¿2â¥Šâ†•16}Â¨ Â¯2+â†•10
â‰ {ğ•Šk: ! (1âŠ¸â†“â‰k â‰¡ {1â†“ğ•©}â‰k) 3â€¿3â€¿3â€¿3â¥Šâ†•81}Â¨ Â¯2+â†•10

!"Ë˜: Result rank too large" % (0âˆ¾254â¥Š2)âŠ¸â¥Šâˆ˜1Ë˜ 0â€¿2â¥Š1
!"â‰: Result rank too large" % (0âˆ¾254â¥Š2)âŠ¸â¥Šâˆ˜1â‰Â¯1 0â€¿2â¥Š1
!"â‰: Result rank too large" % (1â¥ŠËœ 0âˆ¾204â¥Š2)â‰50 1â¥ŠËœ 0âˆ¾100â¥Š2
!"â‰: Result rank too large (204 â‰¡ =ğ•©, 200 â‰¡ =ğ”½v)" % {ğ•Š:(200â¥Š1)â¥Š1}â‰1 (205â¥Š1)â¥Š1

!"â‰: Argument frames don't agree (âŸ¨3âŸ© â‰¡ â‰¢ğ•¨, âŸ¨2âŸ© â‰¡ â‰¢ğ•©, common frame of 1 axes)" % "abc" âŠ¢â‰0 "ab"
!"Ë˜: Argument frames don't agree (âŸ¨3âŸ© â‰¡ â‰¢ğ•¨, âŸ¨2âŸ© â‰¡ â‰¢ğ•©, common frame of 1 axes)" % "abc" âŠ¢Ë˜ "ab"
! âˆ§Â´{ğ•Š: ! (âˆ¾â‰¡{ğ•¨âˆ¾ğ•©}Â´) (<â€¢rand.Rangeâˆ˜â‰ âŠ¸âŠ‘ âŸ¨"ab",1â€¿2,âŸ¨âŸ©,â†•0,""âŸ©) âˆ¾Ëœ (4â€¢rand.Rangeâ‰ )âŠ¸âŠ âŸ¨1, {â‡}, 'a', <'a', <{â‡}, "ab", â†•0, ""âŸ©}Â¨â†•10000

# error cases that could be affected by special code
!"âˆ§: Argument cannot have rank 0" % âˆ§Ë˜â†•2
!"âˆ¨: Argument cannot have rank 0" % âˆ¨Ë˜"a"
!"Expected non-negative integer, got Â¯3" % 2â€¿Â¯3/â‰1 6â€¿2â¥Š0
!"/: Lengths of components of ğ•¨ must match ğ•© (3 â‰  4)" % 1â€¿2â€¿3âŠ¸/Ë˜â‰4â€¿5â€¿6â€¿7
!"/: Simple ğ•¨ must have rank 0 or 1 (2â‰¡=ğ•¨)" % (2â€¿3â€¿1â¥Šâ†•4) /Ë˜ â†•2
!"ğ•¨/ğ•©: Length of compound ğ•¨ must be at most rank of ğ•©" % (<â†•0)/Ë˜â—‹(5âŠ¸â¥Š)<"ab"
!"âŠ: Indexing out-of-bounds (24âˆŠğ•¨, 4â‰¡â‰ ğ•©)" % 1â€¿24âŠâ‰1â†•4â€¿4
!"âŠ: Indexing out-of-bounds (4âˆŠğ•¨, 4â‰¡â‰ ğ•©)" % âŠâ‰1Ëœ6â€¿4â¥Šâ†•24
!"ğ•¨âŠğ•©: ğ•¨ must be an array of numbers or list of such arrays" % 0â€¿@â€¿Â¯1âŠâ‰1 5â€¿2â¥Š0.5
!"Expected integer, got Â¯5.25" % Â¯5.25âŠË˜âˆ˜â€¿4â¥Šâ†•24
!"âŠ: Indexing out-of-bounds (1âˆŠğ•¨, 1â‰¡â‰ ğ•©)" % 0â€¿0â€¿1 âŠË˜â—‹(â‰Ë˜) 10000Ã—â†•3
!"âŠ: ğ•© cannot be a unit" % 0âŠË˜5â¥Š<"a"
!"âŠ: ğ•© cannot be a unit" % (3â€¿0â¥ŠâŸ¨âŸ©)âŠË˜â†•3
!"Expected integer, got 0.1" % 0.1âŠ‘Ë˜3â€¿5â¥Šâ†•15
!"âŠ‘: ğ•© must be a list when ğ•¨ is a number (3â€¿4 â‰¡ â‰¢ğ•©)" % 5âŠ‘Ë˜â†•2â€¿3â€¿4
!">: Result rank too large (80 â‰¡ =ğ•©, 205 â‰¡ =âŠ‘ğ•©)" % >â‰80 (200â¥Š1)â¥Š<(205â¥Š1)â¥Š1
!"â‰: Result rank too large (195 â‰¡ =ğ•©, 210 â‰¡ =ğ”½v)" % >â‰5 (200â¥Š1)â¥Š<(205â¥Š1)â¥Š1
!"âˆ¾: Lengths not matchable (âŸ¨6âŸ© â‰¡ â‰¢ğ•¨, 1â€¿1 â‰¡ â‰¢ğ•©)" % ("abc"âˆ¾"def")âˆ¾Ë˜â—‹(3/â‰)â‰"a"
!"âˆ¾: Argument ranks must differ by 1 or less (0â‰¡=ğ•¨, 2â‰¡=ğ•©)" % 1âˆ¾Ë˜â†•3â€¿3â€¿3
!"âˆ¾: Lengths not matchable (4â€¿2 â‰¡ â‰¢ğ•¨, 3â€¿3 â‰¡ â‰¢ğ•©)" % (3â€¿4â€¿2â¥Š4)âˆ¾Ë˜3â€¿3â€¿3â¥Š5
!"â‰: ğ•¨ and ğ•© must have equal shapes (3â€¿4 â‰¡ â‰¢ğ•¨, 3â€¿3 â‰¡ â‰¢ğ•©)" % (â†•3â€¿4)â‰â‰2 2â€¿3â€¿3â¥Šâ†•18
!"â‰: Result rank too large (255â‰¡=ğ•©)" % â‰â‰âˆ 0â¥ŠËœ255â¥Š1
!"shift: Lengths not matchable (âŸ¨6âŸ© â‰¡ â‰¢ğ•¨, 1â€¿1 â‰¡ â‰¢ğ•©)" % ("abc"âˆ¾"def")Â«Ë˜â—‹(3/â‰)â‰"a"
!"shift: =ğ•¨ must be =ğ•© or Â¯1+=ğ•© (0â‰¡=ğ•¨, 2â‰¡=ğ•©)" % 1Â«Ë˜â†•2â€¿2â€¿2
!"Â»: Argument cannot be a scalar" % Â»â‰0 2â€¿3â€¿1â¥Šâ†•6
!"âŒ½: Argument cannot be a unit" % âŒ½Ë˜â†•10
!"Expected integer, got 1.5" % 1.5â†‘Ë˜â†•2â€¿3â€¿2
!"â†‘: ğ•¨ must have rank at most 1 (1â€¿2 â‰¡ â‰¢ğ•¨)" % (â‰1â€¿2)âŠ¸â†‘Ë˜â†•2â€¿3â€¿2
!"â†“: ğ•¨ must have rank at most 1 (4â€¿2 â‰¡ â‰¢ğ•¨)" % (4â€¿2â¥Šâ†•8)â†“Ë˜â—‹â‰@
!"Integer out of range: 1e20" % 1e20âŒ½Ë˜3â€¿10â¥Š10
!"Expected number" % 3â€¿4â€¿@âŒ½Ë˜â†•3â€¿4
!"Expected integer, got 0.5" % 0.5âŠ¸âŒ½Ë˜4â€¿3â¥Šâ†•12
!"â†‘: Argument must have rank at least 1" % â†‘Ë˜â†•2
!"â†“: Argument must have rank at least 1" % â†“â‰0 2â€¿1â¥Š0
!"âŠ: ğ•© cannot have rank 0" % âŠË˜"abcd"
!"âŠ’: Argument cannot have rank 0" % âŠ’Ë˜"abcd"
!"âˆŠ: Argument cannot have rank 0" % âˆŠË˜"abcd"
!"â‹: ğ•¨ must be sorted" % 0â€¿2â€¿1âŠ¸â‹Ë˜ 3â€¿4â¥Šâ†•12
!"`: Shape of ğ•¨ must match the cell of ğ•© (âŸ¨2âŸ© â‰¡ â‰¢ğ•¨, 2â€¿3 â‰¡ â‰¢ğ•©)" % (2â€¿2â¥Š1)+`Ë˜2â€¿2â€¿3â¥Š0.4
!"`: Shape of ğ•¨ must match the cell of ğ•© (âŸ¨âŸ© â‰¡ â‰¢ğ•¨, 3â€¿3 â‰¡ â‰¢ğ•©)" % 2+`Ë˜â†•3â€¿3â€¿3
!"Â´: Argument must be a list (3â€¿3 â‰¡ â‰¢ğ•©)" % +Â´Ë˜2â€¿3â€¿3â¥Šâ†•18
!"Â´: ğ•© must be a list (3â€¿3 â‰¡ â‰¢ğ•©)" % 1+Â´Ë˜2â€¿3â€¿3â¥Šâ†•18
!"Ë: ğ•© must have rank at least 1" % +ËË˜Ë˜10â€¿10â¥Šâ†•100
!"Ë: ğ•© must have rank at least 1" % âˆ¾Ëâ‰Â¯2 2â€¿3â¥Š9

{âˆ¾ËË˜ â¥ŠâŸœ(â†•Ã—Â´) 2+â†•ğ•©}Â¨ 2â€¿3â€¿4â€¿5 %% â¥ŠâŸœ(â†•Ã—Â´)Â¨   âŸ¨2â€¿3,2â€¿12,2â€¿12â€¿5,2â€¿12â€¿5â€¿6âŸ©
{âˆ¾ËË˜ (2+â†•ğ•©)â¥Š<"hi"}Â¨ 2â€¿3â€¿4â€¿5 %% â¥ŠâŸœ(<"hi")Â¨ âŸ¨2â€¿3,2â€¿12,2â€¿12â€¿5,2â€¿12â€¿5â€¿6âŸ©
{âˆ¾Ëâ‰Â¯2 â¥ŠâŸœ(â†•Ã—Â´) 2+â†•ğ•©}Â¨ 3â€¿4â€¿5 %% â¥ŠâŸœ(â†•Ã—Â´)Â¨ âŸ¨2â€¿3â€¿4,2â€¿3â€¿20,2â€¿3â€¿20â€¿6âŸ©

%USE tcc â‹„ âŸ¨2, 20, Â¯2, Â¯20, 0âŸ© {ğ•¨ â†‘_tcc ğ•© â‹„ ğ•¨ â†“_tcc ğ•©}âŒœ âŸ¨<4, â†•5, 4â€¿5â¥Šâ†•20, 4â€¿5â€¿6â¥Šâ†•120âŸ©
%USE tcc â‹„ âŸ¨<, â‰, âŠ, â¥ŠâŸ© {ğ• _tcc ğ•©}âŒœ âŸ¨<4, â†•5, 4â€¿5â¥Šâ†•20, 4â€¿5â€¿6â¥Šâ†•120, 2â€¿3â€¿4â€¿5â¥Šâ†•120âŸ©
%USE tcc â‹„ âŸ¨<, â‰, â¥ŠâŸ© {ğ• _tcc ğ•©}âŒœ âŸ¨<4, â†•5, 4â€¿5â¥Šâ†•20, 4â€¿5â€¿6â¥Šâ†•120, 2â€¿3â€¿4â€¿5â¥Šâ†•120âŸ©
%USE tcc â‹„ âŸ¨âŠâŸ© {ğ• _tcc ğ•©}âŒœ âŸ¨4â€¿5â¥Šâ†•20, 4â€¿5â€¿6â¥Šâ†•120, 2â€¿3â€¿4â€¿5â¥Šâ†•120âŸ©
%USE tcc â‹„ âŠ_tcc 4â€¿2â¥Šâ†•8 â‹„ 1âŠ_tcc 4â€¿2â¥Šâ†•8 â‹„ âŠ_tcc â†•4â€¿2 â‹„ 1âŠ_tcc â†•4â€¿2
%USE tcc â‹„ âŠ‘_tcc 4â€¿2â¥Šâ†•8 â‹„ 1âŠ‘_tcc 4â€¿2â¥Šâ†•8 â‹„ âŠ‘_tcc â†•4â€¿2 â‹„ 1âŠ‘_tcc â†•4â€¿2

%USE eqvar â‹„ 0â€¿0â€¿0â€¿0 {ğ•¨âŠ¸âŠË˜ğ•©}_eqvar â‰Ë˜â†•5 %% 5â€¿4â¥ŠâŒŠ4Ã·Ëœâ†•20
%USE eqvar â‹„ 0â€¿Â¯1â€¿0â€¿Â¯1 {ğ•¨âŠ¸âŠË˜ğ•©}_eqvar â‰Ë˜â†•5 %% 5â€¿4â¥ŠâŒŠ4Ã·Ëœâ†•20
!"âŠ: Indexing out-of-bounds (1âˆŠğ•¨, 1â‰¡â‰ ğ•©)" % %USE evar â‹„ 0â€¿Â¯1â€¿1â€¿Â¯1 {ğ•¨âŠ¸âŠË˜ğ•©}_evar â‰Ë˜â†•5
!"âŠ: Indexing out-of-bounds (Â¯2âˆŠğ•¨, 1â‰¡â‰ ğ•©)" % %USE evar â‹„ 0â€¿Â¯1â€¿Â¯2â€¿Â¯1 {ğ•¨âŠ¸âŠË˜ğ•©}_evar â‰Ë˜â†•5

(
  %USE IS_HEAPVERIFY
  # big ËË˜ & `Ë˜ tester
  _basicArgs â† { Test _ğ•£ ranks:
    {ğ•Šf: {{f Test 0â€¿1â¥ŠËœ ğ•©âŠ0â€¿2â€¿4â€¿8â€¿32}Â¨ â†•ğ•©â¥Š3 â‹„ 1}Â¨ ranks}Â¨ +â€¿âˆ§â€¿âˆ¨â€¿=â€¿â‰ â€¿âŠ£â€¿âŠ¢
  }
  
  # TODO replace â—‹âŠ¢ with some pureness-preserving â€¢internal.Keep
  # w F _thing x tests F _thingâ‰w x
  _testFoldCells â† {âˆ¨Â´ğ•—=âŠ¢â€¿âŠ£? 0=Ã—Â´(-ğ•¨)â†‘â‰¢ğ•©? 1; heapverify? 0=â‰ â¥Šğ•©? 1 âŠ£ ğ”½Ëâ‰ğ•¨ ğ•©; ! (ğ”½Ëâ‰ğ•¨  â‰¡ ğ”½Ëâ—‹âŠ¢â‰ğ•¨) ğ•©}
  _testScanCells â† {                         heapverify? 0=â‰ â¥Šğ•©? 1 âŠ£ ğ”½`â‰ğ•¨ ğ•©; ! (ğ”½`â‰ğ•¨  â‰¡ ğ”½`â—‹âŠ¢â‰ğ•¨) ğ•©}
  
  {1 ğ•¨ _testFoldCells ğ•©} _basicArgs 2â€¿3â€¿4
  {1 ğ•¨ _testScanCells ğ•©} _basicArgs 2â€¿3â€¿4
  {2 ğ•¨ _testScanCells ğ•©} _basicArgs 3â€¿4
  {2 ğ•¨ _testScanCells ğ•©} _basicArgs 3â€¿4
  
  âŸ¨0, 0â€¿1, 1â€¿0, 2â€¿2, 1, 10, 10â€¿1, 1â€¿10, 30âŸ© {
    ğ•¨â€¿ğ•© â¥ŠÂ¨â†©
    sh â† ğ•¨âˆ¾ğ•©
    cr â† â‰ ğ•©
    +â€¿âˆ§â€¿âˆ¨â€¿=â€¿â‰ â€¿âŠ£â€¿âŠ¢ {
      cr ğ• _testFoldCells ğ•©
      cr ğ• _testScanCells ğ•©
    }âŒœ {0=Ã—Â´sh? ğ•©; âˆ¾âŸ¨ğ•©, Â¬âŒ¾âŠ‘Â¨ ğ•©, Â¬âŒ¾(Â¯1âŠ‘â¥Š)Â¨ ğ•©âŸ©} shâŠ¸â¥ŠÂ¨ 0â€¿1
  }âŒœ âŸ¨0, 1, 2, 8, 32, 8â€¿1, 4â€¿8, 4â€¿2, 59, 60, 63, 80, 81, 200, 640, 641âŸ©
)
